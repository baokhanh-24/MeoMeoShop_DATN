@page "/profile"
@using System.ComponentModel.DataAnnotations
@using MeoMeo.Contract.Commons
@using MeoMeo.Shared.IServices
@using MeoMeo.Contract.DTOs
@using MeoMeo.Domain.Commons.Enums
@using MeoMeo.Shared.Utilities
@using ButtonType = AntDesign.ButtonType
@inject ICustomerClientService CustomerService
@inject IAuthClientService AuthService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject MessageService MessageService
@inject IConfiguration Configuration
@layout ProfileLayout

<div class="profile-info-container">
    <div class="profile-header">
        <Title Level="2">
            <Icon Type="user" />
            Thông tin cá nhân
        </Title>
        <div class="join-info">
            <Tag>Tham gia từ: @GetJoinDate()</Tag>
            <Tag>@GetMemberDays() ngày</Tag>
        </div>
    </div>

    <GridRow Gutter="24">
        <!-- Avatar Section -->
        <GridCol Span="6">
            <Card Title="Ảnh đại diện" Class="avatar-card">
                <div class="avatar-container">
                    @if (!string.IsNullOrEmpty(currentAvatarUrl))
                    {
                        <Avatar Size="AvatarSize.Large" Src="@currentAvatarUrl" Class="profile-avatar"/>
                    }
                    else
                    {
                        <Avatar Size="AvatarSize.Large" Icon="user" Class="profile-avatar"/>
                    }
                </div>
                <div class="avatar-actions">
                    @if (isUploadingAvatar)
                    {
                        <Button Type="@ButtonType.Primary" Block="true" Loading="true">
                            Đang tải...
                        </Button>
                    }
                    else
                    {
                        <div class="avatar-upload-container" style="position: relative;">
                            <Button Type="@ButtonType.Primary" Icon="camera" Block="true">
                                Thay đổi ảnh
                            </Button>
                            <InputFile @ref="avatarInput" OnChange="OnAvatarSelected" accept="image/*"
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"/>
                        </div>
                    }
                    <p class="avatar-note">JPG, PNG hoặc GIF. Tối đa 5MB.</p>
                </div>
            </Card>
        </GridCol>

        <!-- Form Section -->
        <GridCol Span="18">
            <Card Title="Thông tin cá nhân" Class="form-card">
                <Form Model="@model" OnFinish="HandleSubmit" Layout="FormLayout.Vertical" class="profile-form">

                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Mã khách hàng">
                                <Input @bind-Value="@context.Code" Disabled="true"/>
                            </FormItem>
                        </GridCol>
                        <GridCol Span="12">
                            <FormItem Label="Trạng thái" >
                                <Select TItem="SelectOptionModel" 
                                        TItemValue="ECustomerStatus" 
                                        DataSource="@statusOptions"
                                        @bind-Value="@context.Status" 
                                        Disabled
                                        Style="width:100%" 
                                        ItemValue="x => x.Value" 
                                        ItemLabel="x => x.Label"></Select>
                            </FormItem>
                        </GridCol>
                    </GridRow>

                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Họ tên" Name="Name" Rules="@nameRules">
                                <Input @bind-Value="@context.Name" MaxLength="100" Placeholder="Nhập họ và tên"/>
                            </FormItem>
                        </GridCol>
                        <GridCol Span="12">
                            <FormItem Label="Điện thoại" Name="PhoneNumber" Rules="@phoneRules">
                                <Input MaxLength="10" @bind-Value="@context.PhoneNumber" Placeholder="Nhập số điện thoại"/>
                            </FormItem>
                        </GridCol>
                    </GridRow>

                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Email" Name="Email">
                                <Input @bind-Value="@context.Email" Disabled="true"/>
                            </FormItem>
                        </GridCol>
                        <GridCol Span="12">
                            <FormItem Label="Ngày sinh" Name="DateOfBirth" >
                                <DatePicker  DisabledDate="DisableFutureDate" @bind-Value="@context.DateOfBirth" Style="width: 100%"/>
                            </FormItem>
                        </GridCol>
                    </GridRow>

                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Mã số thuế" Name="TaxCode" Rules="@taxCodeRules">
                                <Input MaxLength="14" @bind-Value="@context.TaxCode" Placeholder="Nhập mã số thuế"/>
                            </FormItem>
                        </GridCol>    
                        <GridCol Span="12">
                            <FormItem Label="Giới tính" >
                                <Select TItem="SelectOptionModel<int>"
                                        TItemValue="int"
                                        DataSource="@genderOptions"
                                        @bind-Value="@context.Gender"
                                        Placeholder="Chọn giới tính"
                                        Style="width:100%" 
                                        ItemValue="x => x.Value" 
                                        ItemLabel="x => x.Label"></Select>
                            </FormItem>

                        </GridCol>
                    </GridRow>

                    <FormItem Label="Địa chỉ" Name="Address" Rules="@addressRules">
                        <TextArea MaxLength="500" @bind-Value="@context.Address" Rows="3" Placeholder="Nhập địa chỉ của bạn"></TextArea>
                    </FormItem>

                    <FormItem>
                        <Space>
                            <div class="d-flex gap-2">
                                <Button Type="@ButtonType.Default" OnClick="HandleCancel" Icon="close">
                                    Huỷ
                                </Button>
                                <Button Type="@ButtonType.Primary" HtmlType="submit" Icon="save" Loading="@isLoading">
                                    Lưu thay đổi
                                </Button>
                            </div>
                          
                        </Space>
                    </FormItem>
                </Form>
            </Card>


            <!-- Security Section -->
            <Card Title="Bảo mật" Class="security-card" Style="margin-top: 16px;">
                <Button Type="@ButtonType.Primary" Icon="lock" OnClick="ShowChangePasswordModal">
                    Đổi mật khẩu
                </Button>
            </Card>
        </GridCol>
    </GridRow>
</div>

<Modal Title="Đổi mật khẩu"
       Visible="@isChangePasswordVisible"
       OnOk="@HandleChangePassword"
       OnCancel="@HandlePasswordModalCancel"
       ConfirmLoading="@isChangingPassword">
    <Form Model="@passwordModel" Layout="FormLayout.Vertical">
        <FormItem Label="Mật khẩu hiện tại" Required>
            <InputPassword @bind-Value="@passwordModel.CurrentPassword"/>
        </FormItem>
        <FormItem Label="Mật khẩu mới" Required>
            <InputPassword @bind-Value="@passwordModel.NewPassword"/>
        </FormItem>
        <FormItem Label="Xác nhận mật khẩu mới" Required>
            <InputPassword @bind-Value="@passwordModel.ConfirmPassword"/>
        </FormItem>
    </Form>
</Modal>

@code {
    private CreateOrUpdateCustomerDTO model = new();
    private bool isLoading = false;
    private bool hasChanges = false;
    private int genderSelected;
    private CustomerDTO? originalData;
    private bool isChangePasswordVisible = false;
    private bool isChangingPassword = false;
    private ChangePasswordDTO passwordModel = new();
    public class SelectOptionModel
    {
        public ECustomerStatus Value { get; set; }
        public string Label { get; set; }
    }
    public class SelectOptionModel<T>
    {
        public T Value { get; set; }
        public string Label { get; set; }
    }

    private List<SelectOptionModel<int>> genderOptions = new()
    {
        new() { Value = 0, Label = "Nam" },
        new() { Value = 1, Label = "Nữ" },
        new() { Value = 2, Label = "Khác" }
    };

    private List<SelectOptionModel> statusOptions = new()
    {
        new SelectOptionModel { Value = ECustomerStatus.Enabled, Label = "Hoạt động" },
        new SelectOptionModel { Value = ECustomerStatus.Disabled, Label = "Ngừng hoạt động" },
        new SelectOptionModel { Value = ECustomerStatus.Locked, Label = "Bị khóa" }
    };
    // Avatar upload
    private InputFile? avatarInput;
    private bool isUploadingAvatar = false;
    private string currentAvatarUrl = string.Empty;
    private string backendUrl = string.Empty;

    // Form validation rules
    private FormValidationRule[] nameRules = new[]
    {
        new FormValidationRule { Required = true, Message = "Vui lòng nhập họ tên" },
        new FormValidationRule { Min = 2, Message = "Họ tên phải có ít nhất 2 ký tự" }
    };

    private FormValidationRule[] phoneRules = new[]
    {
        new FormValidationRule { Required = true, Message = "Vui lòng nhập số điện thoại" },
        new FormValidationRule { Pattern = @"^[0-9]{10,11}$", Message = "Số điện thoại không hợp lệ" }
    };

    private bool DisableFutureDate(DateTime date)
    {
        return date.Date > DateTime.Today;
    }

    private FormValidationRule[] taxCodeRules = new[]
    {
        new FormValidationRule { Pattern = @"^\d{10}(\d{3})?$", Message = "Mã số thuế phải có 10 hoặc 13 số" }
    };

    private FormValidationRule[] addressRules = new[]
    {
        new FormValidationRule { Required = true, Message = "Vui lòng nhập địa chỉ" },
        new FormValidationRule { Max = 255, Message = "Địa chỉ tối đa 255 ký tự" }
    };

    protected override async Task OnInitializedAsync()
    {
        backendUrl = (Configuration["ApiSettings:BaseUrl"] ?? string.Empty).TrimEnd('/');
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("CustomerId");

            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var customerId))
            {
                originalData = await CustomerService.GetCustomersByIdAsync(customerId);
                if (originalData != null)
                {
                    model.Id = originalData.Id;
                    model.UserId = originalData.UserId;
                    model.Name = originalData.Name;
                    model.PhoneNumber = originalData.PhoneNumber;
                    model.Address = originalData.Address ?? "";
                    model.DateOfBirth = originalData.DateOfBirth;
                    model.Status = originalData.Status;
                    model.TaxCode = originalData.TaxCode;
                    model.Code = originalData.Code;
                    model.Gender = originalData.Gender;
                    // Set avatar URL
                    if (!string.IsNullOrEmpty(originalData.Avatar))
                    {
                        currentAvatarUrl = $"{backendUrl}/{originalData.Avatar}";
                    }
                    var emailClaim = authState.User.FindFirst("Email");
                    model.Email = emailClaim?.Value ?? "";
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Không thể tải thông tin người dùng!");
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private async Task<IFormFile> ConvertBase64ToFormFile(string base64Data, string fileName, string contentType)
    {
        var bytes = Convert.FromBase64String(base64Data);
        var stream = new MemoryStream(bytes);

        return new FormFile(stream, 0, bytes.Length, fileName, fileName)
        {
            Headers = new HeaderDictionary(),
            ContentType = contentType
        };
    }

    private async Task<string> ConvertToBase64(IBrowserFile file)
    {
        var maxSize = file.ContentType.StartsWith("video/") ? 10 * 1024 * 1024 : 10 * 1024 * 1024;
        using var stream = file.OpenReadStream(maxAllowedSize: maxSize);
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        var bytes = memoryStream.ToArray();
        return Convert.ToBase64String(bytes);
    }

    private async Task OnAvatarSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            MessageService.Error("Vui lòng chọn file ảnh!");
            return;
        }

        if (file.Size > 5 * 1024 * 1024) // 5MB
        {
            MessageService.Error("File ảnh không được vượt quá 5MB!");
            return;
        }

        try
        {
            var base64 = await ConvertToBase64(file);
            var fileUpload = await ConvertBase64ToFormFile(base64, file.Name, file.ContentType);
            var response = await CustomerService.UploadAvatarAsync(fileUpload);
            if (response.ResponseStatus == BaseStatus.Success)
            {
                MessageService.Success("Cập nhật ảnh đại diện thành công!");
                await LoadUserData(); // Reload to get new avatar URL
            }
            else
            {
                MessageService.Error("Cập nhật ảnh đại diện thất bại!");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Có lỗi xảy ra khi tải ảnh!");
            Console.WriteLine($"Error uploading avatar: {ex.Message}");
        }
        finally
        {
            isUploadingAvatar = false;
            StateHasChanged();
        }
    }

    private void ShowChangePasswordModal()
    {
        passwordModel = new ChangePasswordDTO { CustomerId = model.Id };
        isChangePasswordVisible = true;
    }

    private void HandlePasswordModalCancel()
    {
        isChangePasswordVisible = false;
        isChangingPassword = false;
        passwordModel = new();
    }

    private async Task HandleChangePassword()
    {
        if (string.IsNullOrEmpty(passwordModel.CurrentPassword) ||
            string.IsNullOrEmpty(passwordModel.NewPassword) ||
            string.IsNullOrEmpty(passwordModel.ConfirmPassword))
        {
            MessageService.Error("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
        {
            MessageService.Error("Mật khẩu xác nhận không khớp!");
            return;
        }

        if (passwordModel.NewPassword.Length < 6)
        {
            MessageService.Error("Mật khẩu mới phải có ít nhất 6 ký tự!");
            return;
        }

        try
        {
            isChangingPassword = true;
            StateHasChanged();

            var response = await CustomerService.ChangePasswordAsync(passwordModel);
            if (response.ResponseStatus == BaseStatus.Success)
            {
                MessageService.Success("Đổi mật khẩu thành công!");
                isChangePasswordVisible = false;
                passwordModel = new();
            }
            else
            {
                MessageService.Error("Đổi mật khẩu thất bại!");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Có lỗi xảy ra khi đổi mật khẩu!");
            Console.WriteLine($"Error changing password: {ex.Message}");
        }
        finally
        {
            isChangingPassword = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
{
    try
    {
        // Validate Name
        if (string.IsNullOrWhiteSpace(model.Name) || model.Name.Length < 2)
        {
            MessageService.Warning("Họ tên phải có ít nhất 2 ký tự");
            return;
        }

        // Validate Phone
        if (string.IsNullOrWhiteSpace(model.PhoneNumber) || 
            !System.Text.RegularExpressions.Regex.IsMatch(model.PhoneNumber, @"^[0-9]{10,11}$"))
        {
            MessageService.Warning("Số điện thoại không hợp lệ");
            return;
        }

        // Validate DateOfBirth
        if (model.DateOfBirth.HasValue && model.DateOfBirth.Value.Date > DateTime.Today)
        {
            MessageService.Warning("Ngày sinh không được lớn hơn ngày hiện tại");
            return;
        }

        // Validate TaxCode
        if (!string.IsNullOrEmpty(model.TaxCode) && 
            !System.Text.RegularExpressions.Regex.IsMatch(model.TaxCode, @"^\d{10}(\d{3})?$"))
        {
            MessageService.Warning("Mã số thuế phải có 10 hoặc 13 số");
            return;
        }

        // Validate Address
        if (string.IsNullOrWhiteSpace(model.Address))
        {
            MessageService.Warning("Vui lòng nhập địa chỉ");
            return;
        }
        if (model.Address.Length > 255)
        {
            MessageService.Warning("Địa chỉ tối đa 255 ký tự");
            return;
        }
        isLoading = true;
        StateHasChanged();

        var response = await CustomerService.UpdateProfileAsync(model);
        if (response.ResponseStatus == BaseStatus.Success)
        {
            MessageService.Success("Cập nhật thông tin thành công!");
            hasChanges = false;
            await LoadUserData();
        }
        else
        {
            MessageService.Error("Cập nhật thông tin thất bại!");
        }
    }
    catch (Exception ex)
    {
        MessageService.Error("Có lỗi xảy ra khi cập nhật thông tin!");
        Console.WriteLine($"Error updating profile: {ex.Message}");
    }
    finally
    {
        isLoading = false;
        StateHasChanged();
    }
}


    private void HandleCancel()
    {
        if (hasChanges)
        {
            if (originalData != null)
            {
                model.Id = originalData.Id;
                model.UserId = originalData.UserId;
                model.Name = originalData.Name;
                model.PhoneNumber = originalData.PhoneNumber;
                model.Address = originalData.Address ?? "";
                model.DateOfBirth = originalData.DateOfBirth;
                model.Status = originalData.Status;
                model.TaxCode = originalData.TaxCode;
                model.Code = originalData.Code;
                model.Gender = originalData.Gender;
                hasChanges = false;
            }
        }
    }

    private string GetJoinDate()
    {
        if (originalData != null)
        {
            return originalData.CreationTime.ToString("dd/MM/yyyy");
        }

        return DateTime.Now.ToString("dd/MM/yyyy");
    }

    private string GetMemberDays()
    {
        if (originalData != null)
        {
            var days = (DateTime.Now - originalData.CreationTime).Days;
            return days.ToString();
        }

        return "0";
    }

}