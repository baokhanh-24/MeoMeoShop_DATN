@page "/profile"
@using MeoMeo.Shared.IServices
@using MeoMeo.Contract.DTOs
@using MeoMeo.Shared.Utilities
@using ButtonType = AntDesign.ButtonType
@inject ICustomerClientService CustomerService
@inject IAuthClientService AuthService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject MessageService MessageService
@inject IConfiguration Configuration
@layout ProfileLayout

<div class="profile-info-container">
    <div class="profile-header">
        <Title Level="2">
            <Icon Type="user" />
            Thông tin cá nhân
        </Title>
        <div class="join-info">
            <Tag>Tham gia từ: @GetJoinDate()</Tag>
            <Tag>@GetMemberDays() ngày</Tag>
        </div>
    </div>

    <GridRow Gutter="24">
        <!-- Avatar Section -->
        <GridCol Span="6">
            <Card Title="Ảnh đại diện" Class="avatar-card">
                <div class="avatar-container">
                    @if (!string.IsNullOrEmpty(currentAvatarUrl))
                    {
                        <Avatar Size="AvatarSize.Large" Src="@currentAvatarUrl" Class="profile-avatar"/>
                    }
                    else
                    {
                        <Avatar Size="AvatarSize.Large" Icon="user" Class="profile-avatar"/>
                    }
                </div>
                <div class="avatar-actions">
                    @if (isUploadingAvatar)
                    {
                        <Button Type="@ButtonType.Primary" Block="true" Loading="true">
                            Đang tải...
                        </Button>
                    }
                    else
                    {
                        <div class="avatar-upload-container" style="position: relative;">
                            <Button Type="@ButtonType.Primary" Icon="camera" Block="true">
                                Thay đổi ảnh
                            </Button>
                            <InputFile @ref="avatarInput" OnChange="OnAvatarSelected" accept="image/*" 
                                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;"/>
                        </div>
                    }
                    <p class="avatar-note">JPG, PNG hoặc GIF. Tối đa 5MB.</p>
                </div>
            </Card>
        </GridCol>

        <!-- Form Section -->
        <GridCol Span="18">
            <Card Title="Thông tin cá nhân" Class="form-card">
                <Form Model="@model" OnFinish="HandleSubmit" Layout="FormLayout.Vertical" class="profile-form">
                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Họ tên" Name="Name" Rules="@nameRules">
                                <Input @bind-Value="@context.Name" Placeholder="Nhập họ và tên"/>
                            </FormItem>
                        </GridCol>
                        <GridCol Span="12">
                            <FormItem Label="Điện thoại" Name="PhoneNumber" Rules="@phoneRules">
                                <Input @bind-Value="@context.PhoneNumber" Placeholder="Nhập số điện thoại"/>
                            </FormItem>
                        </GridCol>
                    </GridRow>

                    <GridRow Gutter="16">
                        <GridCol Span="12">
                            <FormItem Label="Email" Name="Email">
                                <Input @bind-Value="@context.Email" Placeholder="Nhập email" Disabled="true"/>
                            </FormItem>
                        </GridCol>
                        <GridCol Span="12">
                            <FormItem Label="Ngày sinh" Name="DateOfBirth">
                                <DatePicker @bind-Value="@context.DateOfBirth" Style="width: 100%"/>
                            </FormItem>
                        </GridCol>
                    </GridRow>

                    <FormItem Label="Giới tính" Name="Gender">
                        <RadioGroup @bind-Value="selectedGender">
                            <Radio RadioButton Value="1">Nam</Radio>
                            <Radio RadioButton Value="2">Nữ</Radio>
                            <Radio RadioButton Value="3">Chưa xác định</Radio>
                        </RadioGroup>
                    </FormItem>

                    <FormItem Label="Địa chỉ" Name="Address">
                        <TextArea @bind-Value="@context.Address" Rows="3" Placeholder="Nhập địa chỉ của bạn"></TextArea>
                    </FormItem>

                    <FormItem>
                        <Space>
                            <Button Type="@ButtonType.Default" OnClick="HandleCancel" Icon="close">
                                Huỷ
                            </Button>
                            <Button Type="@ButtonType.Primary" HtmlType="submit" Icon="save" Loading="@isLoading">
                                Lưu thay đổi
                            </Button>
                        </Space>
                    </FormItem>
                </Form>
            </Card>

            <!-- Security Section -->
            <Card Title="Bảo mật" Class="security-card" Style="margin-top: 16px;">
                <Button Type="@ButtonType.Primary" Icon="lock" OnClick="ShowChangePasswordModal">
                    Đổi mật khẩu
                </Button>
            </Card>
        </GridCol>
    </GridRow>
</div>

<Modal Title="Đổi mật khẩu"
       Visible="@isChangePasswordVisible"
       OnOk="@HandleChangePassword"
       OnCancel="@HandlePasswordModalCancel"
       ConfirmLoading="@isChangingPassword">
    <Form Model="@passwordModel" Layout="FormLayout.Vertical">
        <FormItem Label="Mật khẩu hiện tại" Required>
            <InputPassword @bind-Value="@passwordModel.CurrentPassword"/>
        </FormItem>
        <FormItem Label="Mật khẩu mới" Required>
            <InputPassword @bind-Value="@passwordModel.NewPassword"/>
        </FormItem>
        <FormItem Label="Xác nhận mật khẩu mới" Required>
            <InputPassword @bind-Value="@passwordModel.ConfirmPassword"/>
        </FormItem>
    </Form>
</Modal>

@code {
    private CreateOrUpdateCustomerDTO model = new();
    private string selectedGender = "1";
    private bool isLoading = false;
    private bool hasChanges = false;
    private CustomerDTO? originalData;
    private bool isChangePasswordVisible = false;
    private bool isChangingPassword = false;
    private ChangePasswordDTO passwordModel = new();
    
    // Avatar upload
    private InputFile? avatarInput;
    private bool isUploadingAvatar = false;
    private string currentAvatarUrl = string.Empty;
    private string backendUrl = string.Empty;

    // Form validation rules
    private FormValidationRule[] nameRules = new[]
    {
        new FormValidationRule { Required = true, Message = "Vui lòng nhập họ tên" },
        new FormValidationRule { Min = 2, Message = "Họ tên phải có ít nhất 2 ký tự" }
    };

    private FormValidationRule[] phoneRules = new[]
    {
        new FormValidationRule { Required = true, Message = "Vui lòng nhập số điện thoại" },
        new FormValidationRule { Pattern = @"^[0-9]{10,11}$", Message = "Số điện thoại không hợp lệ" }
    };

    protected override async Task OnInitializedAsync()
    {
        backendUrl = (Configuration["ApiSettings:BaseUrl"] ?? string.Empty).TrimEnd('/');
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("CustomerId");

            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var customerId))
            {
                originalData = await CustomerService.GetCustomersByIdAsync(customerId);
                if (originalData != null)
                {
                    model.Id = originalData.Id;
                    model.UserId = originalData.UserId;
                    model.Name = originalData.Name;
                    model.PhoneNumber = originalData.PhoneNumber;
                    model.Address = originalData.Address ?? "";
                    model.DateOfBirth = originalData.DateOfBirth;
                    model.Status = originalData.Status;
                    
                    // Set avatar URL
                    if (!string.IsNullOrEmpty(originalData.Avatar))
                    {
                        currentAvatarUrl = $"{backendUrl}/{originalData.Avatar}";
                    }

                    // Set gender
                    selectedGender = originalData.Gender?.ToString() ?? "1";

                    var emailClaim = authState.User.FindFirst("Email");
                    model.Email = emailClaim?.Value ?? "";
                }
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Không thể tải thông tin người dùng!");
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private async Task OnAvatarSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            MessageService.Error("Vui lòng chọn file ảnh!");
            return;
        }

        if (file.Size > 5 * 1024 * 1024) // 5MB
        {
            MessageService.Error("File ảnh không được vượt quá 5MB!");
            return;
        }

        try
        {
            isUploadingAvatar = true;
            StateHasChanged();

            var success = await CustomerService.UploadAvatarAsync(model.Id, file);
            
            if (success)
            {
                MessageService.Success("Cập nhật ảnh đại diện thành công!");
                await LoadUserData(); // Reload to get new avatar URL
            }
            else
            {
                MessageService.Error("Cập nhật ảnh đại diện thất bại!");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Có lỗi xảy ra khi tải ảnh!");
            Console.WriteLine($"Error uploading avatar: {ex.Message}");
        }
        finally
        {
            isUploadingAvatar = false;
            StateHasChanged();
        }
    }

    private void ShowChangePasswordModal()
    {
        passwordModel = new ChangePasswordDTO { CustomerId = model.Id };
        isChangePasswordVisible = true;
    }

    private void HandlePasswordModalCancel()
    {
        isChangePasswordVisible = false;
        isChangingPassword = false;
        passwordModel = new();
    }

    private async Task HandleChangePassword()
    {
        if (string.IsNullOrEmpty(passwordModel.CurrentPassword) ||
            string.IsNullOrEmpty(passwordModel.NewPassword) ||
            string.IsNullOrEmpty(passwordModel.ConfirmPassword))
        {
            MessageService.Error("Vui lòng điền đầy đủ thông tin!");
            return;
        }

        if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
        {
            MessageService.Error("Mật khẩu xác nhận không khớp!");
            return;
        }

        if (passwordModel.NewPassword.Length < 6)
        {
            MessageService.Error("Mật khẩu mới phải có ít nhất 6 ký tự!");
            return;
        }

        try
        {
            isChangingPassword = true;
            StateHasChanged();

            var success = await CustomerService.ChangePasswordAsync(passwordModel);
            if (success)
            {
                MessageService.Success("Đổi mật khẩu thành công!");
                isChangePasswordVisible = false;
                passwordModel = new();
            }
            else
            {
                MessageService.Error("Đổi mật khẩu thất bại!");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Có lỗi xảy ra khi đổi mật khẩu!");
            Console.WriteLine($"Error changing password: {ex.Message}");
        }
        finally
        {
            isChangingPassword = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // Map gender
            if (int.TryParse(selectedGender, out var genderValue))
            {
                model.Gender = genderValue;
            }

            var response = await CustomerService.UpdateCustomersAsync(model);

            if (response != null)
            {
                MessageService.Success("Cập nhật thông tin thành công!");
                hasChanges = false;
                await LoadUserData();
            }
            else
            {
                MessageService.Error("Cập nhật thông tin thất bại!");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Có lỗi xảy ra khi cập nhật thông tin!");
            Console.WriteLine($"Error updating profile: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void HandleCancel()
    {
        if (hasChanges)
        {
            if (originalData != null)
            {
                model.Name = originalData.Name;
                model.PhoneNumber = originalData.PhoneNumber;
                model.Address = originalData.Address ?? "";
                model.DateOfBirth = originalData.DateOfBirth;
                selectedGender = originalData.Gender?.ToString() ?? "1";
                hasChanges = false;
            }
        }
    }

    private string GetJoinDate()
    {
        if (originalData != null)
        {
            return originalData.CreationTime.ToString("dd/MM/yyyy");
        }

        return DateTime.Now.ToString("dd/MM/yyyy");
    }

    private string GetMemberDays()
    {
        if (originalData != null)
        {
            var days = (DateTime.Now - originalData.CreationTime).Days;
            return days.ToString();
        }

        return "0";
    }
}