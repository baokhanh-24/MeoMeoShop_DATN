@page "/forgot-password"
@using MeoMeo.Contract.DTOs.Auth
@using MeoMeo.Shared.IServices
@using MeoMeo.Shared.Utilities
@using ButtonSize = AntDesign.ButtonSize
@using ButtonType = AntDesign.ButtonType
@inject IAuthClientService AuthService
@inject NavigationManager NavigationManager
@inject MeoMeo.Shared.Utilities.MessageModalService MessageModalService

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <div class="logo-section">
                <img src="/images/logo.png" alt="MeoMeo Shop" class="logo" />
                <h1>MeoMeo Shop</h1>
            </div>
            <p class="welcome-text">Quên mật khẩu?</p>
            <p class="subtitle">Nhập thông tin để lấy lại mật khẩu</p>
        </div>

        <Form Model="@forgotPasswordModel" OnFinish="HandleForgotPassword" Layout="FormLayout.Vertical"
            class="login-form">
            <FormItem Label="Tên đăng nhập" Name="UserName" Rules="@userNameRules">
                <Input @bind-Value="@context.UserName" Placeholder="Nhập tên đăng nhập của bạn"
                    Size="InputSize.Large" />
            </FormItem>

            <FormItem Label="Email" Name="Email" Rules="@emailRules">
                <Input @bind-Value="@context.Email" Placeholder="Nhập email đã đăng ký" Size="InputSize.Large" />
            </FormItem>

            <FormItem>
                <Button Type="@ButtonType.Primary" HtmlType="submit" Size="ButtonSize.Large" Block="true"
                    Loading="@isLoading" Class="login-button">
                    @if (isLoading)
                    {
                        <span>Đang xử lý...</span>
                    }
                    else
                    {
                        <span>Gửi mật khẩu</span>
                    }
                </Button>
            </FormItem>
        </Form>

        <div class="login-footer">
            <div class="register-link">
                <span>Nhớ lại mật khẩu? </span>
                <a href="/login">Đăng nhập ngay</a>
            </div>
        </div>
    </div>
</div>

@code {
    private ForgotPasswordRequest forgotPasswordModel = new();
    private bool isLoading = false;

    private readonly FormValidationRule[] userNameRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập tên đăng nhập!" }
};

    private readonly FormValidationRule[] emailRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập email!" },
new FormValidationRule { Type = FormFieldType.Email, Message = "Email không hợp lệ!" }
};

    private async Task HandleForgotPassword()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await AuthService.ForgotPasswordAsync(forgotPasswordModel);

            if (response?.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                MessageModalService.Success("Mật khẩu mới đã được gửi về email của bạn. Vui lòng kiểm tra hộp thư và đăng nhập lại!");

                // Chuyển về trang login sau 2 giây
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
            else
            {
                var errorMessage = response?.Message ?? "Không thể gửi mật khẩu. Vui lòng kiểm tra lại thông tin!";
                MessageModalService.Error(errorMessage);
            }
        }
        catch (Exception ex)
        {
            MessageModalService.Error("Có lỗi xảy ra trong quá trình xử lý. Vui lòng thử lại!");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
