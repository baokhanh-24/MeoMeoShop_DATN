@page "/register"
@using MeoMeo.Shared.IServices
@using MeoMeo.Shared.Utilities
@using MeoMeo.Contract.DTOs
@using MeoMeo.Domain.Commons.Enums
@using MeoMeo.Contract.Commons
@using ButtonSize = AntDesign.ButtonSize
@using ButtonType = AntDesign.ButtonType
@inject IAuthClientService AuthService
@inject ICustomerClientService CustomerService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject MeoMeo.Shared.Utilities.MessageModalService MessageModalService

<div class="register-container">
    <div class="register-card">
        <div class="register-header">
            <div class="logo-section">
                <img src="/images/logo.png" alt="MeoMeo Shop" class="logo" />
                <h1>MeoMeo Shop</h1>
            </div>
            <p class="welcome-text">Tạo tài khoản mới</p>
            <p class="subtitle">Tham gia cùng chúng tôi để trải nghiệm mua sắm tuyệt vời</p>
        </div>

        <Form Model="@registerModel" OnFinish="HandleRegister" Layout="FormLayout.Vertical" class="register-form">
            <Row Gutter="16">
                <Col Xs="24" Sm="12">
                <FormItem Label="Họ và tên" Name="FullName" Rules="@fullNameRules">
                    <Input @bind-Value="@registerModel.FullName" Placeholder="Nhập họ và tên của bạn"
                        Size="InputSize.Large" />
                </FormItem>
                </Col>
                <Col Xs="24" Sm="12">
                <FormItem Label="Tên đăng nhập" Name="UserName" Rules="@userNameRules">
                    <Input @bind-Value="@registerModel.UserName" Placeholder="Nhập tên đăng nhập"
                        Size="InputSize.Large" />
                </FormItem>
                </Col>
            </Row>

            <Row Gutter="16">
                <Col Xs="24" Sm="12">
                <FormItem Label="Email" Name="Email" Rules="@emailRules">
                    <Input @bind-Value="@registerModel.Email" Placeholder="Nhập email của bạn" Size="InputSize.Large" />
                </FormItem>
                </Col>
                <Col Xs="24" Sm="12">
                <FormItem Label="Số điện thoại" Name="PhoneNumber" Rules="@phoneRules">
                    <Input @bind-Value="@registerModel.PhoneNumber" Placeholder="Nhập số điện thoại"
                        Size="InputSize.Large" />
                </FormItem>
                </Col>
            </Row>

            <Row Gutter="16">
                <Col Xs="24" Sm="12">
                <FormItem Label="Mật khẩu" Name="Password" Rules="@passwordRules">
                    <InputPassword @bind-Value="@registerModel.Password" Placeholder="Nhập mật khẩu"
                        Size="InputSize.Large" />
                </FormItem>
                </Col>
                <Col Xs="24" Sm="12">
                <FormItem Label="Xác nhận mật khẩu" Name="ConfirmPassword" Rules="@confirmPasswordRules">
                    <InputPassword @bind-Value="@registerModel.ConfirmPassword" Placeholder="Nhập lại mật khẩu"
                        Size="InputSize.Large" />
                </FormItem>
                </Col>
            </Row>

            <FormItem>
                <div class="form-actions">
                    <Checkbox @bind-Checked="@agreeToTerms">Tôi đồng ý với <a href="/terms" target="_blank">điều khoản
                            sử dụng</a></Checkbox>
                </div>
            </FormItem>

            <FormItem>
                <Button Type="@ButtonType.Primary" HtmlType="submit" Size="ButtonSize.Large" Block="true"
                    Loading="@isLoading" Class="register-button">
                    @if (isLoading)
                    {
                        <span>Đang đăng ký...</span>
                    }
                    else
                    {
                        <span>Đăng ký</span>
                    }
                </Button>
            </FormItem>
        </Form>

        <div class="register-footer">
            <Divider>hoặc</Divider>
            <div class="login-link">
                <span>Đã có tài khoản? </span>
                <a href="/login">Đăng nhập ngay</a>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterModel registerModel = new();
    private bool isLoading = false;
    private bool agreeToTerms = false;

    private readonly FormValidationRule[] fullNameRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập họ và tên!" }
};

    private readonly FormValidationRule[] userNameRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập tên đăng nhập!" },
new FormValidationRule { Min = 3, Message = "Tên đăng nhập phải có ít nhất 3 ký tự!" }
};

    private readonly FormValidationRule[] emailRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập email!" },
new FormValidationRule { Type = FormFieldType.Email, Message = "Email không hợp lệ!" }
};

    private readonly FormValidationRule[] phoneRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập số điện thoại!" },
new FormValidationRule { Pattern = @"^[0-9]{10,11}$", Message = "Số điện thoại không hợp lệ!" }
};

    private readonly FormValidationRule[] passwordRules = new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng nhập mật khẩu!" },
new FormValidationRule { Min = 6, Message = "Mật khẩu phải có ít nhất 6 ký tự!" }
};

    private FormValidationRule[] confirmPasswordRules => new[]
    {
new FormValidationRule { Required = true, Message = "Vui lòng xác nhận mật khẩu!" }
};



    protected override async Task OnInitializedAsync()
    {
        // Kiểm tra nếu đã đăng nhập thì chuyển về trang chủ
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleRegister()
    {
        if (!agreeToTerms)
        {
            MessageModalService.Warning("Vui lòng đồng ý với điều khoản sử dụng!");
            return;
        }

        // Kiểm tra các trường bắt buộc
        if (string.IsNullOrWhiteSpace(registerModel.FullName))
        {
            MessageModalService.Error("Vui lòng nhập họ và tên!");
            return;
        }

        if (string.IsNullOrWhiteSpace(registerModel.UserName))
        {
            MessageModalService.Error("Vui lòng nhập tên đăng nhập!");
            return;
        }

        if (string.IsNullOrWhiteSpace(registerModel.Email))
        {
            MessageModalService.Error("Vui lòng nhập email!");
            return;
        }

        if (string.IsNullOrWhiteSpace(registerModel.PhoneNumber))
        {
            MessageModalService.Error("Vui lòng nhập số điện thoại!");
            return;
        }

        if (string.IsNullOrWhiteSpace(registerModel.Password))
        {
            MessageModalService.Error("Vui lòng nhập mật khẩu!");
            return;
        }

        if (string.IsNullOrWhiteSpace(registerModel.ConfirmPassword))
        {
            MessageModalService.Error("Vui lòng xác nhận mật khẩu!");
            return;
        }

        // Kiểm tra định dạng email
        if (!IsValidEmail(registerModel.Email))
        {
            MessageModalService.Error("Email không hợp lệ!");
            return;
        }

        // Kiểm tra định dạng số điện thoại
        if (!IsValidPhoneNumber(registerModel.PhoneNumber))
        {
            MessageModalService.Error("Số điện thoại không hợp lệ!");
            return;
        }

        // Kiểm tra password confirmation
        if (registerModel.Password != registerModel.ConfirmPassword)
        {
            MessageModalService.Error("Mật khẩu xác nhận không khớp!");
            return;
        }

        try
        {
            isLoading = true;
            StateHasChanged();

            // Tạo DTO cho đăng ký customer
            var customerDto = new CreateOrUpdateCustomerDTO
            {
                Name = registerModel.FullName.Trim(),
                Email = registerModel.Email.Trim(),
                UserName = registerModel.UserName.Trim(),
                PhoneNumber = registerModel.PhoneNumber.Trim(),
                Password = registerModel.Password.Trim(),
                Status = ECustomerStatus.Enabled,
                Gender = 0 // Mặc định
            };

            // Gọi API đăng ký
            var result = await CustomerService.CreateCustomersAsync(customerDto);

            if (result.ResponseStatus == BaseStatus.Success)
            {
                MessageModalService.Success("Đăng ký thành công! Vui lòng đăng nhập để sử dụng tài khoản.");

                // Chuyển hướng về trang đăng nhập
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                MessageModalService.Error(result.Message ?? "Có lỗi xảy ra trong quá trình đăng ký!");
            }
        }
        catch (Exception ex)
        {
            MessageModalService.Error($"Có lỗi xảy ra trong quá trình đăng ký: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsValidPhoneNumber(string phoneNumber)
    {
        if (string.IsNullOrWhiteSpace(phoneNumber))
            return false;

        // Loại bỏ khoảng trắng và ký tự đặc biệt
        var cleanPhone = new string(phoneNumber.Where(char.IsDigit).ToArray());

        // Kiểm tra số điện thoại Việt Nam: 10-11 số, bắt đầu bằng 0
        return cleanPhone.Length >= 10 && cleanPhone.Length <= 11 && cleanPhone.StartsWith("0");
    }

    public class RegisterModel
    {
        public string FullName { get; set; } = "";
        public string UserName { get; set; } = "";
        public string Email { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
    }
}