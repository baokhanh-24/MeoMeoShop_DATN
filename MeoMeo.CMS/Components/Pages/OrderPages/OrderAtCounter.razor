@page "/order-at-counter"
@using System.ComponentModel.DataAnnotations
@inject IMessageService MessageService
@inject MeoMeo.Shared.IServices.ICustomerClientService CustomerClientService
@inject MeoMeo.Shared.IServices.IProductDetailClientService ProductDetailClientService
@inject MeoMeo.Shared.IServices.IProductClientService ProductClientService
@inject MeoMeo.Shared.IServices.IGhnClientService GhnService
@inject MeoMeo.Shared.IServices.IOrderClientService OrderClientService
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<div class="content-background layout-container">
    <Breadcrumb>
        <BreadcrumbItem>Quản lý hệ thống</BreadcrumbItem>
        <BreadcrumbItem>
            <a class="current">@(DetailsItem != null ? "Cập nhật đơn hàng" : "Thêm mới đơn hàng")</a>
        </BreadcrumbItem>
    </Breadcrumb>
    <div class="group-breadcumb">
        <Button Class="btn-reset w-100px" Icon="close" OnClick="HandleCancel">Hủy</Button>
        <Button Class="btn-reset" Icon="photo_album" OnClick="() => HandleSave(true)">Lưu tạm</Button>
        <Button Class="btn-save" Icon="check" OnClick="() => HandleSave(false)">Lưu</Button>
        @if (HasPermission("ORDER:POS_ORDER:PRINT"))
        {
            <Button Class="btn-reset" Icon="print" OnClick="HandlePrintOrder">In đơn</Button>
        }
        <Button Class="btn-back" Icon="arrow-left" OnClick="HandleGoBack">Quay lại</Button>
    </div>
    <Form Model="OrderModel" Layout="@FormLayout.Vertical" RequiredMark="@FormRequiredMark.Required"
        OnFinish="OnFinish" OnFinishFailed="OnFinishFailed">
        <div class="order-section-general">
            <div class="order-section-general-header">
                <div class="txt-18-n-600 order-section-general-title">Thông tin chung</div>
            </div>
            <Row Gutter="16">
                <AntDesign.Col Lg="8">
                    <FormItem Label="Loại" Required="true">
                        <Select TItem="SelectOption"
                                TItemValue="int"
                                DataSource="@TypeOptions"
                                @bind-Value="@OrderModel.Type"
                                Placeholder="Chọn loại..."
                                ItemValue="x => x.Value"
                                ItemLabel="x => x.Label"
                                OnSelectedItemChanged="HandleTypeChange"
                                ShowSearch="true"
                                AllowClear="true" />
                    </FormItem>
                </AntDesign.Col>
                <AntDesign.Col Lg="8">
                    <FormItem Label="Thời gian đặt hàng" Required="true">
                        <DatePicker @bind-Value="@OrderModel.OrderTime" ShowTime="true" Format="HH:mm - dd/MM/yyyy"
                            DisabledDate="@((current) => current > DateTime.Now)" Style="width: 100%" />
                    </FormItem>
                </AntDesign.Col>
                <AntDesign.Col Lg="8">
                    <FormItem Label="Tên khách hàng" Required="@(OrderType == 2)">
                        <div style="display: flex; gap: 4px;">
                            <Select TItem="Customer"
                                    TItemValue="int?"
                                    DataSource="@Customers"
                                    @bind-Value="@OrderModel.CustomerId"
                                    Placeholder="Chọn khách hàng..."
                                    ItemValue="x => x.Id"
                                    ItemLabel="x => x.Name"
                                    ShowSearch="true"
                                    FilterOption="false"
                                    OnSelectedItemChanged="@(e => OnCustomerChanged(e))"
                                    Loading="@CustomersLoading"
                                    Style="flex: 1"
                                    AllowClear="true">
                                <NotFoundContent>
                                    @if (CustomersLoading)
                                    {
                                        <Spin Size="SpinSize.Default" />
                                    }
                                    else
                                    {
                                        <div style="text-align: center; padding: 8px 0;">Không có dữ liệu phù hợp</div>
                                    }
                                </NotFoundContent>
                            </Select>
                            <Icon Type="plus" OnClick="HandleAddNewCustomer" />
                        </div>
                    </FormItem>
                </AntDesign.Col>
            </Row>
        </div>
        @if (OrderType == 2)
        {
            <div class="order-section-delivery">
                <div class="order-section-delivery-header">
                    <div class="txt-18-n-600">Thông tin nhận hàng</div>
                    <Checkbox @bind-Checked="@UseDefaultAddress"
                        Disabled="@(SelectedCustomer == null || SelectedCustomer.UserId == -1)"
                        class="order-checkbox-default-address">
                        <span class="txt-16-n-400 order-checkbox-default-address-label"
                            style="color: @(SelectedCustomer?.UserId == -1 ? "#999" : "#22313F")">
                            Giao đến địa chỉ mặc định
                        </span>
                    </Checkbox>
                </div>
                <Row Gutter="16" class="order-section-delivery-row-margin">
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Tên người nhận" Required="true">
                            <Input @bind-Value="@OrderModel.Delivery.ConsigneeName" Placeholder="Nhập"
                                MaxLength="255" />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Số điện thoại" Required="true">
                            <Input @bind-Value="@OrderModel.Delivery.ConsigneePhone" Placeholder="Nhập" />
                        </FormItem>
                    </AntDesign.Col>
                </Row>
                <Row Gutter="16" class="order-section-delivery-row-margin">
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Tỉnh/Thành phố" Required="true">
                            <Select TItem="Province"
                                    TItemValue="int?"
                                    DataSource="@Provinces"
                                    @bind-Value="@OrderModel.Delivery.ProvinceId"
                                    Placeholder="Chọn tỉnh/thành phố..."
                                    ItemValue="x => x.Id"
                                    ItemLabel="x => x.Name"
                                    ShowSearch="true"
                                    FilterOption="false"
                                    OnSelectedItemChanged="@(e => HandleProvinceChange(e))"
                                    Loading="@ProvincesLoading"
                                    AllowClear="true" />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Quận/Huyện" Required="true">
                            <Select TItem="District"
                                    TItemValue="int?"
                                    DataSource="@Districts"
                                    @bind-Value="@OrderModel.Delivery.DistrictId"
                                    Placeholder="Chọn quận/huyện..."
                                    ItemValue="x => x.Id"
                                    ItemLabel="x => x.Name"
                                    Disabled="@(SelectedProvinceId == 0)"
                                    ShowSearch="true"
                                    FilterOption="false"
                                    OnSelectedItemChanged="@(e => HandleDistrictChange(e))"
                                    Loading="@DistrictsLoading"
                                    AllowClear="true" />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Phường/Xã" Required="true">
                            <Select TItem="Commune"
                                    TItemValue="int?"
                                    DataSource="@Communes"
                                    @bind-Value="@OrderModel.Delivery.CommuneId"
                                    Placeholder="Chọn phường/xã..."
                                    ItemValue="x => x.Id"
                                    ItemLabel="x => x.Name"
                                    Disabled="@(SelectedDistrictId == 0 || SelectedProvinceId == 0)"
                                    ShowSearch="true"
                                    FilterOption="false"
                                    OnSelectedItemChanged="@(e => HandleCommuneChange(e))"
                                    Loading="@CommunesLoading"
                                    AllowClear="true" />
                        </FormItem>
                    </AntDesign.Col>
                </Row>
                <Row Gutter="16">
                    <AntDesign.Col Lg="16">
                        <FormItem Label="Địa chỉ chi tiết" Required="true">
                            <Input @bind-Value="@OrderModel.Delivery.ConsigneeAddress" Placeholder="Nhập"
                                MaxLength="200" />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Lg="8">
                        <FormItem Label="Ghi chú">
                            <Input @bind-Value="@OrderModel.Delivery.ConsigneeNote" Placeholder="Nhập"
                                MaxLength="500" />
                        </FormItem>
                    </AntDesign.Col>
                </Row>
            </div>
        }
        <div class="order-section-product-search">
            <div class="order-section-product-search-header">
                <div class="order-section-product-search-header-left">
                    @if (SelectedProducts.Any())
                    {
                        <Tooltip Title="Xóa sản phẩm đã chọn">
                            <Icon Type="delete" OnClick="HandleRemoveSelectedProducts" class="order-icon-delete-selected" />
                        </Tooltip>
                    }
                    <span class="txt-18-n-500">Danh sách sản phẩm (@Products.Count)</span>
                    <Popover Content="ProductSearchDropdown"
                             Visible="@SearchDropdownVisible"
                             Trigger="@(new Trigger[] { Trigger.Click })"
                             Placement="Placement.Bottom">
                        <div class="order-section-product-search-input">
                            <Search @bind-Value="@ProductSearchKeyword"
                                    Placeholder="Nhập barcode, mã sản phẩm, tên sản phẩm để tìm kiếm"
                                    @onclick="OnSearchClick"
                                    OnSearch="OnProductSearch"
                                    OnClear="OnSearchClear"
                                    Loading="@SearchingProduct"
                                    class="order-search-input" />
                        </div>
                    </Popover>
                </div>
            </div>
            <div class="order-section-product-search-right"></div>
        </div>
        <div class="order-section-product-table-summary">
            <div class="product-list order-section-product-table">
                <Table DataSource="@Products" @bind-SelectedRows="selectedRows" RowKey="x => x.ProductDetailId"
                    Loading="@ProductsLoading" Size="@TableSize.Small">
                    <ChildContent Context="product">
                        <Selection Type="@selectionType" />
                        <Column TData="string" Title="SKU" Width="136">
                            <div>@product.Sku</div>
                        </Column>
                        <Column TData="string" Title="Ảnh sản phẩm" Width="116">
                            <img src="@product.ImageUrl"
                                 style="width: 40px; height: 40px; object-fit: cover;" />
                        </Column>
                        <Column TData="string" Title="Tên sản phẩm">
                            <div>@product.Name</div>
                        </Column>
                        <Column TData="string" Title="Size" Width="116" Align="@ColumnAlign.Right">
                            <div>@product.SizeName</div>
                        </Column>
                        <Column TData="string" Title="Màu sắc" Width="116" Align="@ColumnAlign.Right">
                            <div>@product.ColourName</div>
                        </Column>
                        <Column TData="decimal" Title="Đơn giá (đ)" Width="116" Align="@ColumnAlign.Right">
                            @product.Price.ToString("N0") đ
                        </Column>
                        <Column TData="int" Title="Số lượng" Width="116" Align="@ColumnAlign.Center">
                            <AntDesign.InputNumber TValue="int" @bind-Value="product.Quantity"
                              Min="1"
                              OnChange="@(value => UpdateProductQuantity(product, value))" />
                        </Column>
                        <Column TData="decimal" Title="Thành tiền (đ)" Width="116" Align="@ColumnAlign.Right">
                            @((product.Price * product.Quantity).ToString("N0")) đ
                        </Column>
                        <ActionColumn Title="Thao tác" Width="80" Align="@ColumnAlign.Right">
                            <Icon Type="delete" OnClick="() => RemoveProduct(product)"
                                  Style="cursor: pointer; color: #ff4d4f;" />
                        </ActionColumn>
                    </ChildContent>
                </Table>
            </div>
            <div class="summary order-section-summary-panel">
                <div class="order-summary-row order-summary-row-total">
                    <div class="txt-14-n-400">Tổng tiền</div>
                    <div class="txt-14-n-500">@CalculateSubTotal().ToString("N0") đ</div>
                </div>
                <Divider class="order-summary-divider" />
                <div class="order-summary-row order-summary-row-shipping">
                    <div class="txt-14-n-400">Phí vận chuyển</div>
                    @if (OrderType == 2)
                    {
                        <AntDesign.InputNumber TValue="decimal" @bind-Value="@ShippingFee"
                      Placeholder="Nhập..."
                      class="order-input-shipping-fee" />
                    }
                    else
                    {
                        <div class="txt-14-n-500">@ShippingFee.ToString("N0") đ</div>
                    }
                </div>
                <Divider class="order-summary-divider" />
                <div class="txt-14-n-500 order-summary-discount-label">Mã giảm giá</div>
                <div class="order-summary-discount-row">
                    <Input @bind-Value="@DiscountCode" Placeholder="Nhập mã giảm giá" MaxLength="20"
                        AllowClear="true" class="order-input-discount-code" />
                    <Button Disabled="@(string.IsNullOrEmpty(DiscountCode) || DiscountCodeResponse != null)"
                        OnClick="CheckDiscountCode">
                        Áp dụng
                    </Button>
                </div>
                @if (!string.IsNullOrEmpty(DiscountCodeError))
                {
                    <div class="txt-12-i-400 order-summary-discount-error">
                        @DiscountCodeError
                    </div>
                }
                @if (DiscountCodeAmount > 0)
                {
                    <div class="order-summary-row order-summary-row-discount">
                        <div class="txt-14-n-400">Giảm giá/ tổng đơn hàng:</div>
                        <div class="txt-14-n-500 order-summary-discount-amount">-@DiscountCodeAmount.ToString("N0") đ</div>
                    </div>
                    <Divider class="order-summary-divider" />
                }
                
                <div class="order-summary-row order-summary-row-final">
                    <div class="order-summary-final-label">Thành tiền</div>
                    <div class="order-summary-final-amount">@CalculateTotal().ToString("N0") đ</div>
                </div>
                <Divider class="order-summary-divider" />
                <div class="order-summary-payment-method">
                    <div class="order-summary-payment-label">Hình thức thanh toán</div>
                    <RadioGroup @bind-Value="@PaymentType" ButtonStyle="@RadioButtonStyle.Solid">
                        <Radio RadioButton Value="0" class="order-radio-payment">Tiền mặt</Radio>
                        <Radio RadioButton Value="1" class="order-radio-payment">Chuyển khoản</Radio>
                    </RadioGroup>
                </div>
            </div>
        </div>
    </Form>
    <Modal Title="Thêm khách hàng mới" Visible="@AddCustomerModalVisible" OnCancel="HandleCloseAddCustomerModal"
        Footer="null">
        <div style="padding: 8px 0;">
            <Form TModel="MeoMeo.Contract.DTOs.CreateOrUpdateCustomerDTO" Model="newCustomerModel" Layout="@FormLayout.Vertical">
                <FormItem Label="Họ và tên" Required="true">
                    <Input @bind-Value="newCustomerModel.Name" Placeholder="Nhập họ và tên" MaxLength="255" />
                </FormItem>
                <FormItem Label="Số điện thoại" Required="true">
                    <Input @bind-Value="newCustomerModel.PhoneNumber" Placeholder="Nhập số điện thoại" MaxLength="20" />
                </FormItem>
                <FormItem Label="Mã khách hàng">
                    <Input @bind-Value="newCustomerModel.Code" Placeholder="Tự động nếu bỏ trống" MaxLength="50" />
                </FormItem>
                <div class="d-flex" style="justify-content: flex-end; gap: 8px;">
                    <Button OnClick="HandleCloseAddCustomerModal">Hủy</Button>
                    <Button Type="AntDesign.ButtonType.Primary" Loading="@creatingCustomer" OnClick="CreateCustomerAsync">Lưu</Button>
                </div>
            </Form>
        </div>
    </Modal>
</div>
@code {
    SelectionType selectionType = SelectionType.Checkbox;
    public class OrderFormModel
    {
        [Required]
        public int Type { get; set; } = 0;
        [Required]
        public DateTime OrderTime { get; set; } = DateTime.Now;
        public int? CustomerId { get; set; }
        public DeliveryInfo Delivery { get; set; } = new();
    }
    IEnumerable<Product> selectedRows = Enumerable.Empty<Product>();
    public class DeliveryInfo
    {
        public string ConsigneeName { get; set; } = string.Empty;
        public string ConsigneePhone { get; set; } = string.Empty;
        public int? ProvinceId { get; set; }
        public int? DistrictId { get; set; }
        public int? CommuneId { get; set; }
        public string ConsigneeAddress { get; set; } = string.Empty;
        public string ConsigneeNote { get; set; } = string.Empty;
    }
    public class SelectOption
    {
        public string Label { get; set; }
        public int Value { get; set; }
    }
    public class Customer
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Phone { get; set; }
        public int UserId { get; set; }
        public string MembershipName { get; set; }
        public int RemainingPoint { get; set; }
    }
    public class Province
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
    public class District
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
    public class Commune
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
    public class Product
    {
        public Guid ProductDetailId { get; set; }
        public string Sku { get; set; }
        public string Name { get; set; }
        public string ImageUrl { get; set; }
        public string SizeName { get; set; }
        public string ColourName { get; set; }
        public decimal Price { get; set; }
        public int Quantity { get; set; } = 1;
    }
    private OrderFormModel OrderModel = new();
    private object? DetailsItem = null;
    private int OrderType = 0;
    private bool UseDefaultAddress = false;
    private Customer? SelectedCustomer = null;
    private int SelectedProvinceId = 0;
    private int SelectedDistrictId = 0;
    private List<SelectOption> TypeOptions = new()
{
new() { Label = "Giao trực tiếp", Value = 0 },
new() { Label = "Giao hàng", Value = 2 }
};
    private List<Customer> Customers = new();
    private List<Province> Provinces = new();
    private List<District> Districts = new();
    private List<Commune> Communes = new();
    private List<Product> Products = new();
    private List<Product> SelectedProducts = new();
    private bool CustomersLoading = false;
    private bool ProvincesLoading = false;
    private bool DistrictsLoading = false;
    private bool CommunesLoading = false;
    private bool ProductsLoading = false;
    private bool SearchingProduct = false;
    private string ProductSearchKeyword = string.Empty;
    private bool SearchDropdownVisible = false;
    private bool AddCustomerModalVisible = false;
    private MeoMeo.Contract.DTOs.CreateOrUpdateCustomerDTO newCustomerModel = new();
    private bool creatingCustomer = false;
    private decimal ShippingFee = 0;
    private string DiscountCode = string.Empty;
    private string? DiscountCodeError = null;
    private object? DiscountCodeResponse = null;
    private decimal DiscountCodeAmount = 0;
    private int PaymentType = 0;
    private string ApiBaseUrl = string.Empty;
    private RenderFragment ProductSearchDropdown => builder =>
    {
        builder.AddContent(0, "Search results here...");
    };
    protected override async Task OnInitializedAsync()
    {
        ApiBaseUrl = Configuration["ApiSettings:BaseUrl"]?.TrimEnd('/') ?? string.Empty;
        await LoadInitialData();
    }
    private async Task HandleCancel()
    {
        Products.Clear();
        SelectedProducts.Clear();
        OrderModel = new();
        SelectedCustomer = null;
        SelectedProvinceId = 0;
        SelectedDistrictId = 0;
        ShippingFee = 0;
        DiscountCode = string.Empty;
        DiscountCodeError = null;
        DiscountCodeResponse = null;
        PaymentType = 0;
        StateHasChanged();
        MessageService.Success("Đã làm mới biểu mẫu");
    }
    private async Task HandleSave(bool isDraft)
    {
        if (!Products.Any())
        {
            MessageService.Warning("Vui lòng chọn sản phẩm");
            return;
        }
        if (OrderType == 2)
        {
            if (string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeName) ||
                string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneePhone) ||
                !OrderModel.Delivery.ProvinceId.HasValue ||
                !OrderModel.Delivery.DistrictId.HasValue ||
                !OrderModel.Delivery.CommuneId.HasValue ||
                string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeAddress))
            {
                MessageService.Warning("Vui lòng nhập đủ thông tin giao hàng");
                return;
            }
        }

        try
        {
            var dto = new MeoMeo.Contract.DTOs.Order.CreatePosOrderDTO
            {
                Type = OrderType == 2 ? MeoMeo.Domain.Commons.Enums.EOrderType.Online : MeoMeo.Domain.Commons.Enums.EOrderType.Store,
                OrderTime = OrderModel.OrderTime,
                PaymentMethod = PaymentType == 0 ? MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Cash : MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Transfer,
                Note = OrderModel.Delivery.ConsigneeNote,
                ShippingFee = ShippingFee,
                DiscountCode = string.IsNullOrWhiteSpace(DiscountCode) ? null : DiscountCode,
                CustomerId = null,
                NewCustomer = SelectedCustomer == null ? new MeoMeo.Contract.DTOs.Order.CreatePosCustomerDTO
                {
                    Name = string.Empty,
                    PhoneNumber = string.Empty
                } : new MeoMeo.Contract.DTOs.Order.CreatePosCustomerDTO
                {
                    Name = SelectedCustomer.Name,
                    PhoneNumber = SelectedCustomer.Phone
                },
                Delivery = OrderType == 2 ? new MeoMeo.Contract.DTOs.Order.CreatePosDeliveryDTO
                {
                    ConsigneeName = OrderModel.Delivery.ConsigneeName,
                    ConsigneePhone = OrderModel.Delivery.ConsigneePhone,
                    ProvinceId = OrderModel.Delivery.ProvinceId ?? 0,
                    DistrictId = OrderModel.Delivery.DistrictId ?? 0,
                    CommuneId = OrderModel.Delivery.CommuneId ?? 0,
                    ConsigneeAddress = OrderModel.Delivery.ConsigneeAddress,
                    ConsigneeNote = OrderModel.Delivery.ConsigneeNote
                } : null,
                Items = Products.Select(p => new MeoMeo.Contract.DTOs.Order.CreatePosOrderItemDTO
                {
                    ProductDetailId = p.ProductDetailId,
                    Quantity = p.Quantity,
                    UnitPrice = p.Price
                }).ToList()
            };

            var resp = await OrderClientService.CreatePosOrderAsync(dto);
            if (resp != null && resp.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                MessageService.Success($"Tạo đơn thành công: {resp.Code}");
                Navigation.NavigateTo($"/orders");
            }
            else
            {
                MessageService.Error(resp?.Message ?? "Tạo đơn thất bại");
            }
        }
        catch
        {
            MessageService.Error("Không thể lưu đơn hàng");
        }
    }
    private async Task HandlePrintOrder()
    {
        MessageService.Info("Tính năng in đơn đang được phát triển");
    }
    private async Task HandleGoBack()
    {
        Navigation.NavigateTo("/orders");
    }
    private async Task HandleTypeChange(SelectOption selectedOption)
    {
        OrderType = selectedOption.Value;
        StateHasChanged();
    }
    private void OnCustomerSearch(string searchText)
    {
        CustomersLoading = true;
        CustomersLoading = false;
        StateHasChanged();
    }
    private void OnCustomerChanged(Customer customer)
    {
        SelectedCustomer = customer;
        if (customer?.UserId == -1)
        {
            UseDefaultAddress = false;
        }
        StateHasChanged();
    }
    private async Task HandleAddNewCustomer()
    {
        AddCustomerModalVisible = true;
        newCustomerModel = new MeoMeo.Contract.DTOs.CreateOrUpdateCustomerDTO();
    }
    private async Task HandleCloseAddCustomerModal()
    {
        AddCustomerModalVisible = false;
    }
    private async Task CreateCustomerAsync()
    {
        if (string.IsNullOrWhiteSpace(newCustomerModel.Name) || string.IsNullOrWhiteSpace(newCustomerModel.PhoneNumber))
        {
            MessageService.Warning("Vui lòng nhập đầy đủ họ tên và số điện thoại");
            return;
        }
        try
        {
            creatingCustomer = true;
            var resp = await CustomerClientService.CreateCustomersAsync(newCustomerModel);
            if (resp != null && resp.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                MessageService.Success(resp.Message ?? "Tạo khách hàng thành công");
                // Reload a small page of customers including the new one
                var custReq = new MeoMeo.Contract.DTOs.GetListCustomerRequestDTO { PageIndex = 1, PageSize = 20, PhoneNumberFilter = newCustomerModel.PhoneNumber };
                var custResp = await CustomerClientService.GetAllCustomersAsync(custReq);
                var list = (custResp.Items ?? new List<MeoMeo.Contract.DTOs.CustomerDTO>())
                    .Select(c => new Customer
                    {
                        Id = 0,
                        Name = c.Name,
                        Phone = c.PhoneNumber,
                        UserId = c.UserId.GetHashCode(),
                        MembershipName = string.Empty,
                        RemainingPoint = 0
                    })
                    .ToList();
                if (list.Any())
                {
                    // Merge or replace
                    Customers = list;
                    SelectedCustomer = Customers.First();
                    OrderModel.CustomerId = SelectedCustomer.Id;
                }
                AddCustomerModalVisible = false;
            }
            else
            {
                MessageService.Error(resp?.Message ?? "Tạo khách hàng thất bại");
            }
        }
        catch
        {
            MessageService.Error("Không thể tạo khách hàng");
        }
        finally
        {
            creatingCustomer = false;
            StateHasChanged();
        }
    }
    private void OnProvinceSearch(string searchText) { }
    private void HandleProvinceChange(Province province)
    {
        SelectedProvinceId = province?.Id ?? 0;
        Districts.Clear();
        Communes.Clear();
        OrderModel.Delivery.DistrictId = null;
        OrderModel.Delivery.CommuneId = null;
        StateHasChanged();
        _ = LoadDistrictsAsync(SelectedProvinceId);
    }
    private void OnDistrictSearch(string searchText) { }
    private void HandleDistrictChange(District district)
    {
        SelectedDistrictId = district?.Id ?? 0;
        Communes.Clear();
        OrderModel.Delivery.CommuneId = null;
        StateHasChanged();
        _ = LoadCommunesAsync(SelectedDistrictId);
    }
    private void OnCommuneSearch(string searchText) { }
    private void HandleCommuneChange(Commune commune)
    {
        OrderModel.Delivery.CommuneId = commune?.Id;
        StateHasChanged();
    }
    private async Task OnSearchClick()
    {
        SearchDropdownVisible = true;
    }
    private async Task OnProductSearch(string searchText)
    {
        try
        {
            SearchingProduct = true;
            ProductSearchKeyword = searchText?.Trim() ?? string.Empty;
            var request = new MeoMeo.Contract.DTOs.ProductDetail.GetListProductDetailRequestDTO
            {
                PageIndex = 1,
                PageSize = 10,
                ProductNameFilter = ProductSearchKeyword,
                SKUFilter = ProductSearchKeyword
            };
            var result = await ProductDetailClientService.GetAllProductDetailAsync(request);
            var items = result.Items ?? new List<MeoMeo.Contract.DTOs.ProductDetail.ProductDetailDTO>();
            Products = items.Select(x => new Product
            {
                ProductDetailId = x.Id,
                Sku = x.Sku ?? string.Empty,
                Name = x.ProductName ?? string.Empty,
                ImageUrl = string.IsNullOrWhiteSpace(x.Thumbnail) ? string.Empty : ($"{ApiBaseUrl}{x.Thumbnail}"),
                SizeName = x.SizeValue ?? string.Empty,
                ColourName = x.ColourName ?? string.Empty,
                Price = (decimal)x.Price,
                Quantity = 1
            }).ToList();
            SearchDropdownVisible = false;
        }
        catch
        {
            MessageService.Error("Không thể tìm sản phẩm");
        }
        finally
        {
            SearchingProduct = false;
            StateHasChanged();
        }
    }
    private async Task OnSearchClear()
    {
        ProductSearchKeyword = string.Empty;
        SearchDropdownVisible = false;
    }
    private async Task HandleRemoveSelectedProducts()
    {
        foreach (var product in SelectedProducts)
        {
            Products.Remove(product);
        }
        SelectedProducts.Clear();
        StateHasChanged();
    }
    private void UpdateProductQuantity(Product product, int quantity)
    {
        product.Quantity = Math.Max(1, quantity);
        StateHasChanged();
    }
    private void RemoveProduct(Product product)
    {
        Products.Remove(product);
        SelectedProducts.Remove(product);
        StateHasChanged();
    }
    private async Task CheckDiscountCode()
    {
        if (string.IsNullOrEmpty(DiscountCode))
            return;
        try
        {
        }
        catch (Exception ex)
        {
            DiscountCodeError = "Lỗi khi kiểm tra mã giảm giá";
        }
    }
    private decimal CalculateSubTotal()
    {
        return Products.Sum(p => p.Price * p.Quantity);
    }
    private decimal CalculateTotal()
    {
        var subTotal = CalculateSubTotal();
        var total = subTotal + ShippingFee - DiscountCodeAmount;
        return Math.Max(0, total);
    }
    private bool HasPermission(string permission)
    {
        return true;
    }
    private async Task LoadInitialData()
    {
        try
        {
            CustomersLoading = true;
            ProvincesLoading = true;

            // Load some customers (first page)
            var custReq = new MeoMeo.Contract.DTOs.GetListCustomerRequestDTO
            {
                PageIndex = 1,
                PageSize = 20
            };
            var custResp = await CustomerClientService.GetAllCustomersAsync(custReq);
            Customers = (custResp.Items ?? new List<MeoMeo.Contract.DTOs.CustomerDTO>())
                .Select(c => new Customer
                {
                    Id = 0,
                    Name = c.Name,
                    Phone = c.PhoneNumber,
                    UserId = c.UserId.GetHashCode(),
                    MembershipName = string.Empty,
                    RemainingPoint = 0
                })
                .ToList();

            // Load provinces via GHN
            var ghnProvinces = await GhnService.GetProvincesAsync();
            Provinces = (ghnProvinces ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
                .Select(p => new Province { Id = p.Id, Name = p.Name })
                .ToList();
        }
        catch
        {
            MessageService.Warning("Không thể tải dữ liệu ban đầu");
        }
        finally
        {
            CustomersLoading = false;
            ProvincesLoading = false;
            StateHasChanged();
        }
    }
    private async Task OnFinish()
    {
    }
    private async Task OnFinishFailed()
    {
    }

    private async Task LoadDistrictsAsync(int provinceId)
    {
        try
        {
            DistrictsLoading = true;
            var ghnDistricts = await GhnService.GetDistrictsAsync(provinceId);
            Districts = (ghnDistricts ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
                .Select(d => new District { Id = d.Id, Name = d.Name })
                .ToList();
        }
        catch
        {
            MessageService.Error("Không thể tải danh sách quận/huyện");
        }
        finally
        {
            DistrictsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCommunesAsync(int districtId)
    {
        try
        {
            CommunesLoading = true;
            var ghnWards = await GhnService.GetWardsAsync(districtId);
            Communes = (ghnWards ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
                .Select(w => new Commune { Id = w.Id, Name = w.Name })
                .ToList();
        }
        catch
        {
            MessageService.Error("Không thể tải danh sách phường/xã");
        }
        finally
        {
            CommunesLoading = false;
            StateHasChanged();
        }
    }
}