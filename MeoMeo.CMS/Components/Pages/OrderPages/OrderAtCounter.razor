@page "/order-at-counter"
@using System.ComponentModel.DataAnnotations
@using AntDesign
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Configuration
@using MeoMeo.Contract.DTOs
@using MeoMeo.Contract.DTOs.Order
@using MeoMeo.Contract.DTOs.OrderDetail
@using MeoMeo.Contract.DTOs.Product
@using MeoMeo.Domain.Commons.Enums
@using MeoMeo.Shared.Utilities
@inject IMessageService MessageService
@inject IJSRuntime JSRuntime
@inject MeoMeo.Shared.IServices.ICustomerClientService CustomerClientService
@inject MeoMeo.Shared.IServices.IProductClientService ProductClientService
@inject MeoMeo.Shared.IServices.IGhnClientService GhnService
@inject MeoMeo.Shared.IServices.IOrderClientService OrderClientService
@inject MeoMeo.Shared.IServices.IVoucherClientService VoucherClientService
@inject IApiCaller ApiCaller
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<div class="content-background layout-container">

    <div class="group-breadcumb d-flex justify-content-between mb-3">
        <Breadcrumb>
            <BreadcrumbItem>Qu·∫£n l√Ω h·ªá th·ªëng</BreadcrumbItem>
            <BreadcrumbItem>
                <a class="current">ƒê∆°n h√†ng t·∫°i qu·∫ßy</a>
            </BreadcrumbItem>
        </Breadcrumb>
        <div>
            <Button Class="btn-reset w-100px" Icon="close" OnClick="HandleCancel">H·ªßy</Button>
            <Button Class="btn-reset" Icon="photo_album" OnClick="() => HandleSave(true)">@(CurrentOrderId.HasValue ? "C·∫≠p nh·∫≠t" : "L∆∞u t·∫°m")</Button>
            <Button Class="btn-save" Icon="check" OnClick="() => HandleSave(false)">@(CurrentOrderId.HasValue ? "Ho√†n th√†nh ƒë∆°n h√†ng" : "Thanh to√°n ƒë∆°n h√†ng")</Button>

            <Button Class="btn-save" Icon="printer" OnClick="HandlePaymentAndPrint"
                Disabled="@(!Products.Any())">Thanh to√°n & In h√≥a ƒë∆°n
            </Button>

            <Button Class="btn-back" Icon="arrow-left" OnClick="HandleGoBack">Quay l·∫°i</Button>
        </div>
    </div>
    
    <!-- Panel ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω -->
    <div class="pending-orders-panel"
        style="margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e8e8e8;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
            <h6 style="margin: 0; color: #333; font-weight: 600;">
                <Icon Type="clock-circle" Style="margin-right: 8px;" />
                ƒê∆°n h√†ng ƒëang x·ª≠ l√Ω (@PendingOrders.Count)
            </h6>
                @if (PendingOrders.Count > 3)
                {
                                            <div style="font-size: 12px; color: #666; display: flex; align-items: center; gap: 4px;">
                                                <Icon Type="swap" />
                                                K√©o ngang ƒë·ªÉ xem th√™m
                                            </div>
                }
            </div>
            <Button Type="@AntDesign.ButtonType.Link" Icon="reload" OnClick="LoadPendingOrders"
                Loading="@LoadingPendingOrders">
                L√†m m·ªõi
            </Button>
        </div>
        
        @if (PendingOrders.Any())
        {
                                    <div class="pending-orders-container">
                                        <div class="pending-orders-scroll">
                                            @foreach (var order in PendingOrders)
                                            {
                                                                        <div class="pending-order-item">
                                                                            <div @onclick="() => ResumeOrder(order)" class="pending-order-content">
                                                                                <div class="pending-order-code">@order.Code</div>
                                                                                <div class="pending-order-customer">@order.CustomerName</div>
                                                                                <div class="pending-order-amount">@order.TotalAmount.ToString("N0") ƒë</div>
                                                                                <div class="pending-order-time">@order.CreationTime.ToString("HH:mm dd/MM")</div>
                                </div>
                                                                             <div class="pending-order-actions">
                                                                                 <Popconfirm Title="H·ªßy ƒë∆°n h√†ng n√†y?" OnConfirm="() => CancelPendingOrder(order)" OkText="H·ªßy ƒë∆°n"
                                                                                     CancelText="Kh√¥ng">
                                                                                     <Icon Type="stop" class="cancel-icon" />
                                                                                 </Popconfirm>
                                </div>
                            </div>
                    }
                        </div>
                </div>
        }
        else
        {
                <div style="text-align: center; color: #999; padding: 20px;">
                    <Icon Type="inbox" Style="font-size: 24px; margin-bottom: 8px;" />
                    <div>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒëang x·ª≠ l√Ω</div>
                </div>
        }
    </div>
    
    <Form Model="OrderModel" Layout="@AntDesign.FormLayout.Vertical" RequiredMark="@AntDesign.FormRequiredMark.Required"
        OnFinish="OnFinish" OnFinishFailed="OnFinishFailed">
        <div class="order-section-general">
            <div class="order-section-general-header">
                <div class="txt-18-n-600 order-section-general-title">Th√¥ng tin chung</div>
            </div>
            <Row Gutter="16">
                <AntDesign.Col Lg="12">
                    <FormItem Label="Lo·∫°i" Required="true">
                        <Select TItem="SelectOption" TItemValue="int" DataSource="@TypeOptions"
                            @bind-Value="@OrderModel.Type" Placeholder="Ch·ªçn lo·∫°i..." ItemValue="x => x.Value"
                            ItemLabel="x => x.Label" OnSelectedItemChanged="HandleTypeChange" ShowSearch="true"
                            AllowClear="true" />
                    </FormItem>
                </AntDesign.Col>
                <AntDesign.Col Lg="12">
                    <FormItem Label="T√™n kh√°ch h√†ng" Required="@(OrderType == 2)">
                        <div style="display: flex; gap: 4px;">
                            <Select TItem="Customer" TItemValue="Guid ?" DataSource="@Customers"
                                @bind-Value="@OrderModel.CustomerId" Placeholder="Ch·ªçn kh√°ch h√†ng..."
                                ItemValue="x => x.Id" ItemLabel="x => x.Name" ShowSearch="true" FilterOption="false"
                                OnSelectedItemChanged="@(e => OnCustomerChanged((Customer)e))" Loading="@CustomersLoading"
                                Style="flex: 1" AllowClear="true">
                                <NotFoundContent>
                                    @if (CustomersLoading)
                                    {
                                            <Spin Size="@AntDesign.SpinSize.Default" />
                                    }
                                    else
                                    {
                                            <div style="text-align: center; padding: 8px 0;">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</div>
                                    }
                                </NotFoundContent>
                            </Select>
                            <Icon Type="plus" OnClick="HandleAddNewCustomer" />
                        </div>
                    </FormItem>
                </AntDesign.Col>
            </Row>
        </div>

        @if (OrderType == 2)
        {
                <div class="order-section-delivery">
                    <div class="order-section-delivery-header">
                        <div class="txt-18-n-600">Th√¥ng tin nh·∫≠n h√†ng</div>
                        <Checkbox @bind-Checked="@UseDefaultAddress" Disabled="@(SelectedCustomer == null)"
                            class="order-checkbox-default-address">
                            <span class="txt-16-n-400 order-checkbox-default-address-label"
                                style="color: @(SelectedCustomer?.Id == Guid.Empty ? "#999" : "#22313F")">
                                Giao ƒë·∫øn ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                            </span>
                        </Checkbox>
                    </div>
                    <Row Gutter="16" class="order-section-delivery-row-margin">
                        <AntDesign.Col Lg="8">
                            <FormItem Label="T√™n ng∆∞·ªùi nh·∫≠n" Required="true">
                                <Input @bind-Value="@OrderModel.Delivery.ConsigneeName" Placeholder="Nh·∫≠p" MaxLength="255" />
                            </FormItem>
                        </AntDesign.Col>
                        <AntDesign.Col Lg="8">
                            <FormItem Label="S·ªë ƒëi·ªán tho·∫°i" Required="true">
                                <Input @bind-Value="@OrderModel.Delivery.ConsigneePhone" Placeholder="Nh·∫≠p" />
                            </FormItem>
                        </AntDesign.Col>
                    </Row>
                    <Row Gutter="16" class="order-section-delivery-row-margin">
                        <AntDesign.Col Lg="8">
                            <FormItem Label="T·ªânh/Th√†nh ph·ªë" Required="true">
                                <Select TItem="Province" TItemValue="int?" DataSource="@Provinces"
                                    @bind-Value="@OrderModel.Delivery.ProvinceId" Placeholder="Ch·ªçn t·ªânh/th√†nh ph·ªë..."
                                    ItemValue="x => x.Id" ItemLabel="x => x.Name" ShowSearch="true" FilterOption="false"
                                    OnSelectedItemChanged="@(e => HandleProvinceChange(e))" Loading="@ProvincesLoading"
                                    AllowClear="true" />
                            </FormItem>
                        </AntDesign.Col>
                        <AntDesign.Col Lg="8">
                            <FormItem Label="Qu·∫≠n/Huy·ªán" Required="true">
                                <Select TItem="District" TItemValue="int?" DataSource="@Districts"
                                    @bind-Value="@OrderModel.Delivery.DistrictId" Placeholder="Ch·ªçn qu·∫≠n/huy·ªán..."
                                    ItemValue="x => x.Id" ItemLabel="x => x.Name" Disabled="@(SelectedProvinceId == 0)"
                                    ShowSearch="true" FilterOption="false"
                                    OnSelectedItemChanged="@(e => HandleDistrictChange(e))" Loading="@DistrictsLoading"
                                    AllowClear="true" />
                            </FormItem>
                        </AntDesign.Col>
                        <AntDesign.Col Lg="8">
                            <FormItem Label="Ph∆∞·ªùng/X√£" Required="true">
                                <Select TItem="Commune" TItemValue="int?" DataSource="@Communes"
                                    @bind-Value="@OrderModel.Delivery.CommuneId" Placeholder="Ch·ªçn ph∆∞·ªùng/x√£..."
                                    ItemValue="x => x.Id" ItemLabel="x => x.Name"
                                    Disabled="@(SelectedDistrictId == 0 || SelectedProvinceId == 0)" ShowSearch="true"
                                    FilterOption="false" OnSelectedItemChanged="@(e => HandleCommuneChange(e))"
                                    Loading="@CommunesLoading" AllowClear="true" />
                            </FormItem>
                        </AntDesign.Col>
                    </Row>
                    <Row Gutter="16">
                        <AntDesign.Col Lg="16">
                            <FormItem Label="ƒê·ªãa ch·ªâ chi ti·∫øt" Required="true">
                                <Input @bind-Value="@OrderModel.Delivery.ConsigneeAddress" Placeholder="Nh·∫≠p" MaxLength="200" />
                            </FormItem>
                        </AntDesign.Col>
                        <AntDesign.Col Lg="8">
                            <FormItem Label="Ghi ch√∫">
                                <Input @bind-Value="@OrderModel.Delivery.ConsigneeNote" Placeholder="Nh·∫≠p" MaxLength="500" />
                            </FormItem>
                        </AntDesign.Col>
                    </Row>
                </div>
        }
        <div class="order-section-product-search">
            <div class="order-section-product-search-header">
                <div class="order-section-product-search-header-left">
                    @if (SelectedProducts.Any())
                    {
                            <Tooltip Title="X√≥a s·∫£n ph·∫©m ƒë√£ ch·ªçn">
                                <Icon Type="delete" OnClick="HandleRemoveSelectedProducts" class="order-icon-delete-selected" />
                            </Tooltip>
                    }
                    <span class="txt-18-n-500">Danh s√°ch s·∫£n ph·∫©m (@Products.Count)</span>
                    <div class="search-controls">
                        <Button Type="@AntDesign.ButtonType.Default" Icon="qr_code" OnClick="StartQRCodeScan"
                            class="qr-scan-btn" Disabled="@IsQRCodeScanning">
                            <Icon Type="qr_code" />
                            Qu√©t QR Code (F3)
                        </Button>
                        <div class="order-section-product-search-input">
                            <Tooltip Title="T√¨m ki·∫øm s·∫£n ph·∫©m (F1)">
                                <Search @bind-Value="@ProductSearchKeyword" Width="600"
                                    Placeholder="Nh·∫≠p barcode, m√£ s·∫£n ph·∫©m, t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm"
                                    OnSearch="OnProductSearch" OnClear="OnSearchClear" Loading="@SearchingProduct"
                                    class="order-search-input" Id="product-search-input" />
                            </Tooltip>
                            @if (SearchResults.Any() && SearchDropdownVisible)
                            {
                                    <div class="search-results-dropdown">
                                        @foreach (var product in SearchResults.Take(5))
                                        {
                                                <div class="search-result-item" @onclick="() => AddProductToOrder(product)">
                                                    <Image Fallback="@(ApiBaseUrl + "/Images/fallback.jpeg")"
                                                        Src="@(ApiBaseUrl + "/" + product.Thumbnail)" Class="search-result-image" />
                                                    <div class="search-result-info">
                                                        <div class="search-result-name">@product.ProductName</div>
                                                        <div class="search-result-sku">SKU: @product.SKU</div>
                                                        <div class="search-result-sku">M√†u s·∫Øc: @product.ColourName - Size:
                                                            @product.SizeValue</div>
                                                        <div class="search-result-price">
                                                            @if (product.SalePrice.HasValue && product.SalePrice < product.Price)
                                                            {
                                                                    <span
                                                                        style="text-decoration: line-through; color: #999; margin-right: 8px;">@product.Price.ToString("N0")
                                                                        ƒë</span>
                                                                    <span
                                                                        style="color: #ff4d4f; font-weight: bold;">@product.SalePrice.Value.ToString("N0")
                                                                        ƒë</span>
                                                                    @if (product.MaxDiscount.HasValue)
                                                                    {
                                                                            <span
                                                                                style="background: #ff4d4f; color: white; padding: 2px 4px; border-radius: 2px; font-size: 10px; margin-left: 4px;">-@product.MaxDiscount.Value.ToString("0")%</span>
                                                                    }
                                                            }
                                                            else
                                                            {
                                                                    @(product.Price.ToString("N0") + "ƒë")
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="search-result-stock">
                                                        <Tag Color="@(product.StockQuantity > 0 ? "green" : "red")">
                                                            @(product.StockQuantity > 0 ? $"C√≤n {product.StockQuantity}" : "H·∫øt h√†ng")
                                                        </Tag>
                                                    </div>
                                                </div>
                                        }
                                        @if (SearchResults.Count > 5)
                                        {
                                                <div class="search-result-more">
                                                                                            <Button Type="@AntDesign.ButtonType.Link" OnClick="async () => await ShowAllSearchResults()">
                                                        Xem th√™m @(SearchResults.Count - 5) s·∫£n ph·∫©m...
                                                    </Button>
                                                </div>
                                        }
                                    </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="order-section-product-search-right"></div>
        </div>
        <div class="order-section-product-table-summary">
            <div class="product-list order-section-product-table">
                <Table DataSource="@Products" @bind-SelectedRows="selectedRows" RowKey="x => x.ProductDetailId"
                    Loading="@ProductsLoading" Size="@AntDesign.TableSize.Small">
                    <ChildContent Context="product">
                        <Selection Type="@AntDesign.SelectionType.Checkbox" />
                        <Column TData="string" Title="SKU" Width="136">
                            <div>@product.Sku</div>
                        </Column>
                        <Column TData="string" Title="·∫¢nh s·∫£n ph·∫©m" Width="116">
                            <Image Width="80" Height="80" Fallback="@(ApiBaseUrl + "/Images/fallback.jpeg")"
                                   Src="@(ApiBaseUrl + "/" + product.Image)" Class="search-result-image" />
                        </Column>
                        <Column TData="string" Title="T√™n s·∫£n ph·∫©m">
                            <div>@product.ProductName</div>
                        </Column>
                        <Column TData="string" Title="Size" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            <div>@product.SizeName</div>
                        </Column>
                        <Column TData="string" Title="M√†u s·∫Øc" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            <div>@product.ColourName</div>
                        </Column>
                        <Column TData="decimal" Title="ƒê∆°n gi√° (ƒë)" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            @if (product.Discount > 0)
                            {
                                    <div>
                                        <span
                                            style="text-decoration: line-through; color: #999; display: block; font-size: 11px;">@product.OriginalPrice.ToString("N0")
                                            ƒë</span>
                                                            <span style="color: #ff4d4f; font-weight: bold;">@product.Price.ToString("N0")
                                            ƒë</span>
                                    </div>
                            }
                            else
                            {
                                    @(product.Price.ToString("N0") + "ƒë")
                            }
                        </Column>
                        <Column TData="int" Title="S·ªë l∆∞·ª£ng" Width="116" Align="@AntDesign.ColumnAlign.Center">
                            <AntDesign.InputNumber TValue="int" @bind-Value="product.Quantity" Min="1"
                                OnChange="@(value => UpdateProductQuantity(product, value))" />
                        </Column>
                        <Column TData="decimal" Title="Gi·∫£m gi√° (ƒë)" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            @if (product.Discount > 0)
                            {
                                                        <span style="color: #52c41a;">-@product.Discount.ToString("N0") ƒë</span>
                            }
                            else
                            {
                                                        <span style="color: #999;">0 ƒë</span>
                            }
                        </Column>
                        <Column TData="decimal" Title="Gi·∫£m gi√° (%)" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            @if (product.Discount > 0)
                            {
                                                        var discountPercent = Math.Round((product.Discount / product.OriginalPrice) * 100, 1);
                                                        <span style="color: #ff4d4f; font-weight: bold;">-@discountPercent%</span>
                            }
                            else
                            {
                                                        <span style="color: #999;">0%</span>
                            }
                        </Column>
                        <Column TData="decimal" Title="Th√†nh ti·ªÅn (ƒë)" Width="116" Align="@AntDesign.ColumnAlign.Right">
                            @(product.GrandTotal.ToString("N0") + "ƒë")
                        </Column>
                        <ActionColumn Title="Thao t√°c" Width="80" Align="@AntDesign.ColumnAlign.Right">
                            <Icon Type="delete" OnClick="() => RemoveProduct(product)"
                                Style="cursor: pointer; color: #ff4d4f;" />
                        </ActionColumn>
                    </ChildContent>
                </Table>
            </div>
            <div class="summary order-section-summary-panel">
                <div class="order-summary-row order-summary-row-total">
                    <div class="txt-14-n-400">T·ªïng ti·ªÅn</div>
                    <div class="txt-14-n-500">@CalculateSubTotal().ToString("N0") ƒë</div>
                </div>
                <Divider class="order-summary-divider" />
                <div class="order-summary-row order-summary-row-shipping">
                    <div class="txt-14-n-400">Ph√≠ v·∫≠n chuy·ªÉn</div>
                    @if (OrderType == 2)
                    {
                            <AntDesign.InputNumber TValue="decimal" @bind-Value="@ShippingFee" Placeholder="Nh·∫≠p..."
                                class="order-input-shipping-fee" />
                    }
                    else
                    {
                            <div class="txt-14-n-500">@ShippingFee.ToString("N0") ƒë</div>
                    }
                </div>
                <Divider class="order-summary-divider" />
                <div class="txt-14-n-500 order-summary-discount-label">M√£ gi·∫£m gi√°/Voucher</div>
                <div class="order-summary-discount-row">
                    <Input @bind-Value="@SelectedVoucherCode" 
                           Placeholder="Ch·ªçn voucher" 
                           ReadOnly="true"
                           class="order-input-discount-code" 
                           OnClick="ShowVoucherModal" />
                    <Button OnClick="ShowVoucherModal" Icon="gift">
                        Ch·ªçn
                    </Button>
                    @if (SelectedVoucherId.HasValue)
                    {
                                                <Button OnClick="RemoveVoucher" Icon="close" Type="@AntDesign.ButtonType.Text" />
                    }
                </div>
                @if (!string.IsNullOrEmpty(DiscountCodeError))
                {
                        <div class="txt-12-i-400 order-summary-discount-error">
                            @DiscountCodeError
                        </div>
                }
                @if (DiscountCodeAmount > 0)
                {
                        <div class="order-summary-row order-summary-row-discount">
                                                <div class="txt-14-n-400">Gi·∫£m gi√° voucher:</div>
                            <div class="txt-14-n-500 order-summary-discount-amount">-@DiscountCodeAmount.ToString("N0") ƒë
                            </div>
                            <Icon Type="close" @onclick="RemoveDiscountCode" class="remove-discount-icon" />
                        </div>
                        <Divider class="order-summary-divider" />
                }

                <div class="order-summary-row order-summary-row-final">
                    <div class="order-summary-final-label">Th√†nh ti·ªÅn</div>
                    <div class="order-summary-final-amount">@CalculateTotal().ToString("N0") ƒë</div>
                </div>
                <Divider class="order-summary-divider" />
                <div class="order-summary-payment-method">
                    <div class="order-summary-payment-label">H√¨nh th·ª©c thanh to√°n</div>
                    <div style="display: flex; gap: 8px;">
                        <Button Type="@(PaymentType == 0 ? AntDesign.ButtonType.Primary : AntDesign.ButtonType.Default)" 
                                OnClick="SelectCashPayment"
                                Style="flex: 1; height: 40px;">
                            <Icon Type="wallet" Style="margin-right: 4px;" />
                            Ti·ªÅn m·∫∑t
                        </Button>
                        <Button Type="@(PaymentType == 1 ? AntDesign.ButtonType.Primary : AntDesign.ButtonType.Default)" 
                                OnClick="SelectTransferPayment"
                                Style="flex: 1; height: 40px;">
                            <Icon Type="bank" Style="margin-right: 4px;" />
                            Chuy·ªÉn kho·∫£n
                        </Button>
                    </div>
                    
                </div>
            </div>
        </div>
    </Form>
    <Modal Title="Th√™m kh√°ch h√†ng m·ªõi" Visible="@AddCustomerModalVisible" OnCancel="HandleCloseAddCustomerModal"
        Footer="null">
        <div style="padding: 8px 0;">
            <Form TModel="MeoMeo.Contract.DTOs.CreateQuickCustomerDTO" Model="newCustomerModel"
                Layout="@AntDesign.FormLayout.Vertical">
                <FormItem Label="H·ªç v√† t√™n" Required="true">
                    <Input @bind-Value="newCustomerModel.Name" Placeholder="Nh·∫≠p h·ªç v√† t√™n" MaxLength="255" />
                </FormItem>
                <FormItem Label="S·ªë ƒëi·ªán tho·∫°i" Required="true">
                    <Input @bind-Value="newCustomerModel.PhoneNumber" Placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" MaxLength="20" />
                </FormItem>
                <FormItem Label="ƒê·ªãa ch·ªâ">
                    <Input @bind-Value="newCustomerModel.Address" Placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ (t√πy ch·ªçn)"
                        MaxLength="200" />
                </FormItem>
                <div class="d-flex" style="justify-content: flex-end; gap: 8px;">
                    <Button OnClick="HandleCloseAddCustomerModal">H·ªßy</Button>
                    <Button Type="AntDesign.ButtonType.Primary" Loading="@creatingCustomer"
                        OnClick="CreateQuickCustomerAsync">T·∫°o nhanh
                    </Button>
                </div>
            </Form>
        </div>
    </Modal>

    <!-- Voucher Selection Modal -->
    <Modal Title="@($"Ch·ªçn Voucher ({AvailableVouchers?.Count ?? 0} voucher kh·∫£ d·ª•ng)")" 
           Visible="@VoucherModalVisible" 
           OnCancel="CloseVoucherModal"
           Width="900"
           Footer="null"
           Class="voucher-modal">
        <div style="max-height: 500px; overflow-y: auto;">
            @if (AvailableVouchers?.Any() == true)
            {
                                        <div class="voucher-list">
                                            @foreach (var voucher in AvailableVouchers)
                                            {
                                                                        <div class="voucher-item @(voucher.CanUse ? "voucher-usable" : "voucher-unusable") @(SelectedVoucherId == voucher.Id ? "voucher-selected" : "")"
                                                                             @onclick="@(() => SelectVoucher(voucher))">
                                                                            <div class="voucher-header">
                                                                                <div class="voucher-code">@voucher.Code</div>
                                                                                <div class="voucher-discount">
                                                                                    @if (voucher.Type == MeoMeo.Domain.Commons.Enums.EVoucherType.byPercentage)
                                                                                    {
                                                                                                                <span class="discount-percentage">Gi·∫£m @voucher.Discount%</span>
                                                                                                                @if (voucher.MaxDiscount > 0)
                                                                                                                {
                                                                                                                                            <span class="discount-max">(t·ªëi ƒëa @voucher.MaxDiscount.ToString("N0") ƒë)</span>
                                                                                                                }
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                                                <span class="discount-amount">Gi·∫£m @voucher.Discount.ToString("N0") ƒë</span>
                                                                                    }
                                                                                </div>
                                                                            </div>
                                                                            <div class="voucher-details">
                                                                                <div class="voucher-condition">
                                                                                    <Icon Type="shopping-cart" />
                                                                                    ƒê∆°n t·ªëi thi·ªÉu: @voucher.MinOrder.ToString("N0") ƒë
                                                                                </div>
                                                                                <div class="voucher-expiry">
                                                                                    <Icon Type="calendar" />
                                                                                    HSD: @voucher.EndDate.ToString("dd/MM/yyyy")
                                                                                </div>
                                                                                @if (voucher.MaxTotalUse.HasValue)
                                                                                {
                                                                                                            <div class="voucher-limit">
                                                                                                                <Icon Type="user" />
                                                                                                                Gi·ªõi h·∫°n: @voucher.MaxTotalUse l∆∞·ª£t
                                                                                                            </div>
                                                                                }
                                                                                @if (voucher.MaxTotalUsePerCustomer.HasValue)
                                                                                {
                                                                                                            <div class="voucher-limit-per-customer">
                                                                                                                <Icon Type="team" />
                                                                                                                M·ªói kh√°ch: @voucher.MaxTotalUsePerCustomer l∆∞·ª£t
                                                                                                            </div>
                                                                                }
                                                                            </div>
                                                                            @if (voucher.CanUse)
                                                                            {
                                                                                                        <div class="voucher-savings">
                                                                                                            Ti·∫øt ki·ªám: @voucher.CalculatedDiscountAmount.ToString("N0") ƒë
                                                                                                        </div>
                                                                            }
                                                                            else if (!string.IsNullOrEmpty(voucher.Reason))
                                                                            {
                                                                                                        <div class="voucher-error">
                                                                                                            <Icon Type="exclamation-circle" />
                                                                                                            @voucher.Reason
                                                                                                        </div>
                                                                            }
                                                                        </div>
                                            }
                                        </div>
            }
            else
            {
                                        <div class="voucher-empty-state">
                                            <div class="empty-icon">üéÅ</div>
                                            <div class="empty-title">Kh√¥ng c√≥ voucher n√†o kh·∫£ d·ª•ng</div>
                                            <div class="empty-description">Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† ƒë·∫£m b·∫£o ƒë∆°n h√†ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ xem voucher</div>
                                            <div class="empty-tips">
                                                <div class="tip-item">üí° ƒê∆°n h√†ng c·∫ßn ƒë·∫°t gi√° tr·ªã t·ªëi thi·ªÉu</div>
                                                <div class="tip-item">üë§ Voucher c√≥ th·ªÉ gi·ªõi h·∫°n theo kh√°ch h√†ng</div>
                                                <div class="tip-item">‚è∞ Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c c·ªßa voucher</div>
                                            </div>
                                        </div>
            }
        </div>
    </Modal>

    <!-- Cancel Order Modal -->
    <Modal Title="H·ªßy ƒë∆°n h√†ng" 
           Visible="@CancelOrderModalVisible" 
           OnOk="@(async () => await ConfirmCancelOrder())"
           OnCancel="CloseCancelOrderModal"
           Width="500">
        <div style="padding: 16px 0;">
            <div style="margin-bottom: 16px;">
                <strong>ƒê∆°n h√†ng:</strong> @OrderToCancel?.Code
            </div>
            <div style="margin-bottom: 16px;">
                <strong>Kh√°ch h√†ng:</strong> @OrderToCancel?.CustomerName
            </div>
            <div style="margin-bottom: 16px;">
                <strong>T·ªïng ti·ªÅn:</strong> @OrderToCancel?.TotalPrice.ToString("N0") ƒë
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                    L√Ω do h·ªßy ƒë∆°n h√†ng <span style="color: red;">*</span>
                </label>
                <TextArea @bind-Value="@CancelReason" 
                         Placeholder="Nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng..." 
                         Rows="4" 
                         MaxLength="500"
                         ShowCount="true" />
            </div>
        </div>
    </Modal>

    <!-- Payment Info Modal -->
    <Modal Title="Th√¥ng tin chuy·ªÉn kho·∫£n" 
           Visible="@PaymentInfoModalVisible" 
           OnCancel="ClosePaymentInfoModal"
           Width="600"
           Footer="null">
        <div style="padding: 20px 0;">
            <div style="display: flex; gap: 24px; align-items: flex-start;">
                @if (!string.IsNullOrEmpty(QrBase64Image))
                {
                        <div style="text-align: center;">
                            <img src="@QrBase64Image" style="width: 200px; height: 200px; border: 1px solid #d9d9d9; border-radius: 8px;" />
                            <div style="margin-top: 12px; font-size: 14px; color: #666;">
                                Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n
                            </div>
                        </div>
                }
                <div style="flex: 1;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #1890ff;">
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 16px; font-weight: 600; color: #1890ff; margin-bottom: 8px;">
                                Th√¥ng tin chuy·ªÉn kho·∫£n
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <Icon Type="credit-card" Style="margin-right: 8px; color: #1890ff;" />
                                <span style="font-weight: 500; color: #333;">S·ªë t√†i kho·∫£n:</span>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #d9d9d9;">
                                <span style="font-weight: bold; font-size: 16px; color: #1890ff;">@AccountNumber</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <Icon Type="bank" Style="margin-right: 8px; color: #1890ff;" />
                                <span style="font-weight: 500; color: #333;">Ng√¢n h√†ng:</span>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #d9d9d9;">
                                <span style="font-weight: bold; color: #333;">Vietcombank - VCB</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <Icon Type="user" Style="margin-right: 8px; color: #1890ff;" />
                                <span style="font-weight: 500; color: #333;">Ch·ªß t√†i kho·∫£n:</span>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #d9d9d9;">
                                <span style="font-weight: bold; color: #333;">BACH HONG LIEN</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <Icon Type="file-text" Style="margin-right: 8px; color: #1890ff;" />
                                <span style="font-weight: 500; color: #333;">N·ªôi dung:</span>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #d9d9d9;">
                                <span style="font-weight: bold; color: #333;">@AddInfo</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <Icon Type="dollar" Style="margin-right: 8px; color: #ff4d4f;" />
                                <span style="font-weight: 500; color: #333;">S·ªë ti·ªÅn:</span>
                            </div>
                            <div style="background: #fff2f0; padding: 12px; border-radius: 4px; border: 1px solid #ffccc7;">
                                <span style="font-weight: bold; font-size: 18px; color: #ff4d4f;">@CalculateTotal().ToString("N0") ƒë</span>
                            </div>
                        </div>

                        <div style="background: #e6f7ff; padding: 12px; border-radius: 4px; border: 1px solid #91d5ff;">
                            <div style="display: flex; align-items: center;">
                                <Icon Type="info-circle" Style="margin-right: 8px; color: #1890ff;" />
                                <span style="font-size: 13px; color: #1890ff; font-style: italic;">
                                    ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x√°c nh·∫≠n sau khi qu·∫£n tr·ªã vi√™n ki·ªÉm tra thanh to√°n.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Modal>
</div>

@code {

    public class OrderFormModel
    {
        [Required] public int Type { get; set; } = 0;
        public Guid? CustomerId { get; set; }
        public DeliveryInfo Delivery { get; set; } = new();
    }

    IEnumerable<OrderDetailDTO> selectedRows = Enumerable.Empty<OrderDetailDTO>();

    public class DeliveryInfo
    {
        public string ConsigneeName { get; set; } = string.Empty;
        public string ConsigneePhone { get; set; } = string.Empty;
        public int? ProvinceId { get; set; }
        public int? DistrictId { get; set; }
        public int? CommuneId { get; set; }
        public string ConsigneeAddress { get; set; } = string.Empty;
        public string ConsigneeNote { get; set; } = string.Empty;
    }

    public class SelectOption
    {
        public string Label { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    public class Customer
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
    }

    public class Province
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class District
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class Commune
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }


    // S·ª≠ d·ª•ng DTO c√≥ s·∫µn thay v√¨ t·ª± ƒë·ªãnh nghƒ©a
    public class OrderVoucher
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public decimal DiscountAmount { get; set; }
        public decimal DiscountPercent { get; set; }
        public decimal MinOrderAmount { get; set; }
        public DateTime ExpiryDate { get; set; }
    }

    // Class cho ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω
    public class PendingOrderItem
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string CustomerName { get; set; } = string.Empty;
        public decimal TotalAmount { get; set; }
        public DateTime CreationTime { get; set; }
        public int Status { get; set; } // 0: Draft, 1: Pending, etc.
    }

    private OrderFormModel OrderModel = new();
    private object? DetailsItem = null;
    private int OrderType = 0;
    private bool UseDefaultAddress = false;
    private Customer? SelectedCustomer = null;
    private int SelectedProvinceId = 0;
    private int SelectedDistrictId = 0;

    private List<SelectOption> TypeOptions = new()
{
new() { Label = "Giao tr·ª±c ti·∫øp", Value = 0 },
new() { Label = "Giao h√†ng", Value = 2 }
};

    private List<Customer> Customers = new();
    private List<Province> Provinces = new();
    private List<District> Districts = new();
    private List<Commune> Communes = new();
    private List<OrderDetailDTO> Products = new();
    private List<OrderDetailDTO> SelectedProducts = new();
    private List<ProductSearchResponseDTO> SearchResults = new();
    private bool CustomersLoading = false;
    private bool ProvincesLoading = false;
    private bool DistrictsLoading = false;
    private bool CommunesLoading = false;
    private bool ProductsLoading = false;
    private bool SearchingProduct = false;
    private bool CheckingDiscount = false;
    private string ProductSearchKeyword = string.Empty;
    private bool SearchDropdownVisible = false;
    private bool AddCustomerModalVisible = false;
    private CreateQuickCustomerDTO newCustomerModel = new();
    private bool creatingCustomer = false;
    private decimal ShippingFee = 0;
    private string DiscountCode = string.Empty;
    private string? DiscountCodeError = null;
    private decimal DiscountCodeAmount = 0;
    private OrderVoucher? SelectedVoucher = null;
    private Guid? SelectedVoucherId = null;
    private string SelectedVoucherCode = string.Empty;
    private List<AvailableVoucherDTO> AvailableVouchers = new();
    private bool LoadingVouchers = false;
    private bool VoucherModalVisible = false;
    
    // Cancel Order Modal
    private bool CancelOrderModalVisible = false;
    private OrderDTO? OrderToCancel = null;
    private string CancelReason = "Kh√°ch h√†ng y√™u c·∫ßu h·ªßy";
    
    // Payment Info Modal
    private bool PaymentInfoModalVisible = false;
    
    private int PaymentType = 0;
    private string ApiBaseUrl = string.Empty;
    private bool IsBarcodeScanning = false;
    private bool IsQRCodeScanning = false;
    private Guid? CurrentOrderId = null; // ID c·ªßa ƒë∆°n h√†ng ƒë√£ t·∫°o th√†nh c√¥ng
    private string CurrentOrderCode = string.Empty; // M√£ ƒë∆°n h√†ng ƒë√£ t·∫°o th√†nh c√¥ng
    private List<PendingOrderItem> PendingOrders = new(); // Danh s√°ch ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω
    private bool LoadingPendingOrders = false;
    
    // Transfer payment info
    private string? QrBase64Image { get; set; }
    public string? AccountNumber { get; set; } = "1014640175";
    public string? AddInfo { get; set; } = "Thanh Toan Don Hang";
    public string? BankBin { get; set; } = "970436";

    private ProductSearchRequestDTO requestSearchProduct = new ProductSearchRequestDTO
    {
        PageIndex = 1,
        PageSize = 20,
        InStockOnly = true
    };


    protected override async Task OnInitializedAsync()
    {
        ApiBaseUrl = Configuration["ApiSettings:BaseUrl"]?.TrimEnd('/') ?? string.Empty;
        await LoadInitialData();
        await LoadPendingOrders(); // Load ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω
        //
        // // Set focus to search input
        // await Task.Delay(100);
        // await JSRuntime.InvokeVoidAsync("setFocus", "product-search-input");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Add keyboard shortcuts
            await JSRuntime.InvokeVoidAsync("addKeyboardShortcuts");
        }
    }

    private void HandleCancel()
    {
        ClearAllData();
        MessageService.Success("ƒê√£ l√†m m·ªõi th√†nh c√¥ng");
    }

    private void ClearAllData()
    {
        // Clear s·∫£n ph·∫©m
        Products.Clear();
        SelectedProducts.Clear();
        SearchResults.Clear();
        SearchDropdownVisible = false;
        ProductSearchKeyword = string.Empty;
        
        // Clear form data
        OrderModel = new();
        OrderType = 0;
        OrderModel.Type = 0;
        
        // Clear customer data
        SelectedCustomer = null;
        OrderModel.CustomerId = null;
        
        // Clear delivery data
        SelectedProvinceId = 0;
        SelectedDistrictId = 0;
        UseDefaultAddress = false;
        
        // Clear payment & discount data
        ShippingFee = 0;
        DiscountCode = string.Empty;
        DiscountCodeError = null;
        DiscountCodeAmount = 0;
        PaymentType = 0;
        QrBase64Image = null;
        
        // Clear voucher data
        SelectedVoucher = null;
        SelectedVoucherId = null;
        SelectedVoucherCode = string.Empty;
        AvailableVouchers.Clear();
        
        // Clear order data
        CurrentOrderId = null;
        CurrentOrderCode = string.Empty;
        
        // Clear modal states
        AddCustomerModalVisible = false;
        VoucherModalVisible = false;
        CancelOrderModalVisible = false;
        PaymentInfoModalVisible = false;
        OrderToCancel = null;
        CancelReason = "Kh√°ch h√†ng y√™u c·∫ßu h·ªßy";
        
        StateHasChanged();
    }

    private async Task HandleSave(bool isDraft)
    {
        if (!Products.Any())
        {
            MessageService.Warning("Vui l√≤ng ch·ªçn s·∫£n ph·∫©m");
            return;
        }

        if (SelectedCustomer == null || SelectedCustomer.Id == Guid.Empty)
        {
            MessageService.Warning("Vui l√≤ng ch·ªçn kh√°ch h√†ng");
            return;
        }

        if (OrderType == 2)
        {
            if (string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeName) ||
            string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneePhone) ||
            !OrderModel.Delivery.ProvinceId.HasValue ||
            !OrderModel.Delivery.DistrictId.HasValue ||
            !OrderModel.Delivery.CommuneId.HasValue ||
            string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeAddress))
            {
                MessageService.Warning("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin giao h√†ng");
                return;
            }
        }

        try
        {
            var dto = new CreatePosOrderDTO
            {
                Type = OrderType == 2 ? MeoMeo.Domain.Commons.Enums.EOrderType.Online : MeoMeo.Domain.Commons.Enums.EOrderType.Store,
                PaymentMethod = PaymentType == 0 ? MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Cash :
            MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Transfer,
                Note = OrderModel.Delivery.ConsigneeNote,
                ShippingFee = ShippingFee,
                Status = isDraft ? EOrderStatus.Pending : EOrderStatus.Completed,
                DiscountCode = string.IsNullOrWhiteSpace(DiscountCode) ? null : DiscountCode,
                CustomerId = SelectedCustomer?.Id ?? Guid.Empty,
                Delivery = OrderType == 2
            ? new MeoMeo.Contract.DTOs.Order.CreatePosDeliveryDTO
            {
                ConsigneeName = OrderModel.Delivery.ConsigneeName,
                ConsigneePhone = OrderModel.Delivery.ConsigneePhone,
                ProvinceId = OrderModel.Delivery.ProvinceId ?? 0,
                DistrictId = OrderModel.Delivery.DistrictId ?? 0,
                CommuneId = OrderModel.Delivery.CommuneId ?? 0,
                ConsigneeAddress = OrderModel.Delivery.ConsigneeAddress,
                ConsigneeNote = OrderModel.Delivery.ConsigneeNote
                    
            }
            : null,
                Items = Products.Select(p => new MeoMeo.Contract.DTOs.Order.CreatePosOrderItemDTO
                {
                    Id = p.Id, // OrderDetail Id
                    ProductDetailId = p.ProductDetailId,
                    PromotionDetailId = p.PromotionDetailId == Guid.Empty ? null : p.PromotionDetailId,
                    Sku = p.Sku,
                    Price = p.Price,
                    OriginalPrice = p.OriginalPrice,
                    Quantity = p.Quantity,
                    ProductName = p.ProductName,
                    Discount = p.Discount,
                    Image = p.Image,
                    SizeName = p.SizeName,
                    ColourName = p.ColourName
                }).ToList()
            };

            // N·∫øu ƒë√£ c√≥ CurrentOrderId th√¨ update, n·∫øu kh√¥ng th√¨ t·∫°o m·ªõi
            var resp = CurrentOrderId.HasValue
                ? await OrderClientService.UpdatePosOrderAsync(CurrentOrderId.Value, dto)
                : await OrderClientService.CreatePosOrderAsync(dto);

            if (resp != null && resp.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                // L∆∞u th√¥ng tin ƒë∆°n h√†ng ƒë√£ t·∫°o/c·∫≠p nh·∫≠t th√†nh c√¥ng
                CurrentOrderId = resp.OrderId;
                CurrentOrderCode = resp.Code ?? string.Empty;
                
                if (CurrentOrderId.HasValue && CurrentOrderId != Guid.Empty)
                {
                    MessageService.Success($"C·∫≠p nh·∫≠t ƒë∆°n th√†nh c√¥ng: {resp.Code}");
                }
                else
                {
                    MessageService.Success($"T·∫°o ƒë∆°n th√†nh c√¥ng: {resp.Code}");
                }
                
                if (isDraft)
                {
                    MessageService.Info("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m. B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c ch·ªânh s·ª≠a ho·∫∑c thanh to√°n.");
                }
                else
                {
                    MessageService.Info("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh th√†nh c√¥ng. B·∫°n c√≥ th·ªÉ in h√≥a ƒë∆°n ho·∫∑c t·∫°o ƒë∆°n m·ªõi.");
                    
                    // Clear to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ chu·∫©n b·ªã ƒë∆°n h√†ng m·ªõi
                    ClearAllData();
                }
                
                await LoadPendingOrders();
            }
            else
            {
                MessageService.Error(resp?.Message ?? (CurrentOrderId.HasValue ? "C·∫≠p nh·∫≠t ƒë∆°n th·∫•t b·∫°i" : "T·∫°o ƒë∆°n th·∫•t b·∫°i"));
            }
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ l∆∞u ƒë∆°n h√†ng");
        }
    }

    private async Task HandlePaymentAndPrint()
    {
        if (!Products.Any())
        {
            MessageService.Warning("Vui l√≤ng ch·ªçn s·∫£n ph·∫©m");
            return;
        }

        if (SelectedCustomer == null || SelectedCustomer.Id == Guid.Empty)
        {
            MessageService.Warning("Vui l√≤ng ch·ªçn kh√°ch h√†ng");
            return;
        }

        if (OrderType == 2)
        {
            if (string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeName) ||
            string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneePhone) ||
            !OrderModel.Delivery.ProvinceId.HasValue ||
            !OrderModel.Delivery.DistrictId.HasValue ||
            !OrderModel.Delivery.CommuneId.HasValue ||
            string.IsNullOrWhiteSpace(OrderModel.Delivery.ConsigneeAddress))
            {
                MessageService.Warning("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin giao h√†ng");
                return;
            }
        }

        try
        {
            // 1. Thanh to√°n ƒë∆°n h√†ng (t·∫°o/c·∫≠p nh·∫≠t v·ªõi status Completed)
            var dto = new CreatePosOrderDTO
            {
                Type = OrderType == 2 ? MeoMeo.Domain.Commons.Enums.EOrderType.Online : MeoMeo.Domain.Commons.Enums.EOrderType.Store,
                PaymentMethod = PaymentType == 0 ? MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Cash :
                MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Transfer,
                Note = OrderModel.Delivery.ConsigneeNote,
                ShippingFee = ShippingFee,
                Status = EOrderStatus.Completed, // Lu√¥n Completed khi thanh to√°n
                DiscountCode = string.IsNullOrWhiteSpace(DiscountCode) ? null : DiscountCode,
                CustomerId = SelectedCustomer?.Id ?? Guid.Empty,
                Delivery = OrderType == 2
            ? new MeoMeo.Contract.DTOs.Order.CreatePosDeliveryDTO
            {
                ConsigneeName = OrderModel.Delivery.ConsigneeName,
                ConsigneePhone = OrderModel.Delivery.ConsigneePhone,
                ProvinceId = OrderModel.Delivery.ProvinceId ?? 0,
                DistrictId = OrderModel.Delivery.DistrictId ?? 0,
                CommuneId = OrderModel.Delivery.CommuneId ?? 0,
                ConsigneeAddress = OrderModel.Delivery.ConsigneeAddress,
                ConsigneeNote = OrderModel.Delivery.ConsigneeNote
                    
            }
            : null,
                Items = Products.Select(p => new MeoMeo.Contract.DTOs.Order.CreatePosOrderItemDTO
                {
                    Id = p.Id,
                    ProductDetailId = p.ProductDetailId,
                    PromotionDetailId = p.PromotionDetailId == Guid.Empty ? null : p.PromotionDetailId,
                    Sku = p.Sku,
                    Price = p.Price,
                    OriginalPrice = p.OriginalPrice,
                    Quantity = p.Quantity,
                    ProductName = p.ProductName,
                    Discount = p.Discount,
                    Image = p.Image,
                    SizeName = p.SizeName,
                    ColourName = p.ColourName
                }).ToList()
            };

            // T·∫°o/c·∫≠p nh·∫≠t ƒë∆°n h√†ng
            var resp = CurrentOrderId.HasValue
                ? await OrderClientService.UpdatePosOrderAsync(CurrentOrderId.Value, dto)
                : await OrderClientService.CreatePosOrderAsync(dto);

            if (resp != null && resp.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                CurrentOrderId = resp.OrderId;
                CurrentOrderCode = resp.Code ?? string.Empty;

                // 2. In h√≥a ƒë∆°n chi ti·∫øt v·ªõi d·ªØ li·ªáu t·ª´ API
                await PrintDetailedReceiptFromApi(resp);

                MessageService.Success($"Thanh to√°n th√†nh c√¥ng: {resp.Code}");
                
                // Clear data sau khi thanh to√°n
                ClearAllData();
                await LoadPendingOrders();
            }
            else
            {
                MessageService.Error(resp?.Message ?? "Thanh to√°n th·∫•t b·∫°i");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Kh√¥ng th·ªÉ thanh to√°n ƒë∆°n h√†ng: " + ex.Message);
        }
    }

    private async Task PrintDetailedReceiptFromApi(CreatePosOrderResultDTO orderData)
    {
        try
        {
            // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ API response
            var receiptData = new
            {
                // Th√¥ng tin ƒë∆°n h√†ng
                orderCode = orderData.Code,
                orderId = orderData.OrderId,
                orderDate = orderData.CreationTime.ToString("dd/MM/yyyy HH:mm"),
                orderType = orderData.Type == MeoMeo.Domain.Commons.Enums.EOrderType.Online ? "Giao h√†ng" : "Giao tr·ª±c ti·∫øp",
                status = "ƒê√£ thanh to√°n",
                    
                // Th√¥ng tin kh√°ch h√†ng
                customerName = orderData.CustomerName ?? "Kh√°ch l·∫ª",
                customerPhone = orderData.CustomerPhoneNumber ?? "",
                customerEmail = orderData.CustomerEmail ?? "",
                    
                // Th√¥ng tin nh√¢n vi√™n
                employeeName = orderData.EmployeeName ?? "",
                employeePhone = orderData.EmployeePhoneNumber ?? "",
                    
                // Th√¥ng tin giao h√†ng (n·∫øu c√≥)
                deliveryInfo = orderData.Type == MeoMeo.Domain.Commons.Enums.EOrderType.Online && orderData.Delivery != null ? new
                {
                    consigneeName = orderData.Delivery.ConsigneeName,
                    consigneePhone = orderData.Delivery.ConsigneePhone,
                    address = orderData.Delivery.ConsigneeAddress,
                    note = orderData.Delivery.ConsigneeNote
                } : null,
                    
                // Chi ti·∫øt s·∫£n ph·∫©m
                items = orderData.OrderDetails?.Select(p => new
                {
                    productName = p.ProductName,
                    sku = p.Sku,
                    size = p.SizeName,
                    colour = p.ColourName,
                    quantity = p.Quantity,
                    unitPrice = p.Price,
                    originalPrice = p.OriginalPrice,
                    discount = p.Discount,
                    discountPercent = p.Discount, // Discount ƒë√£ l√† % r·ªìi
                    total = p.Price * p.Quantity, // Price ƒë√£ l√† gi√° sau gi·∫£m gi√° r·ªìi
                    image = p.Image
                }).ToList(),
                    
                // T·ªïng k·∫øt
                subTotal = orderData.OrderDetails?.Sum(p => p.Price * p.Quantity) ?? 0,
                shippingFee = orderData.ShippingFee,
                discountAmount = orderData.OrderDetails?.Sum(p => p.Discount) ?? 0,
                voucherDiscount = DiscountCodeAmount, // T√≠nh t·ª´ voucher ƒë√£ ch·ªçn
                total = orderData.TotalPrice,
                    
                // Th√¥ng tin thanh to√°n
                paymentMethod = orderData.PaymentMethod == MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Cash ? "Ti·ªÅn m·∫∑t" : "Chuy·ªÉn kho·∫£n",
                paymentStatus = "ƒê√£ thanh to√°n",
                    
                // QR Code (n·∫øu chuy·ªÉn kho·∫£n)
                qrCode = orderData.PaymentMethod == MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Transfer ? QrBase64Image : null,
                bankInfo = orderData.PaymentMethod == MeoMeo.Domain.Commons.Enums.EOrderPaymentMethod.Transfer ? new
                {
                    accountNumber = AccountNumber,
                    bankName = "Vietcombank - VCB",
                    accountHolder = "BACH HONG LIEN",
                    content = AddInfo
                } : null,
                    
                // Ghi ch√∫
                note = orderData.Note ?? "",
                    
                // Th√¥ng tin c·ª≠a h√†ng
                storeInfo = new
                {
                    name = "MeoMeo Shop",
                    address = "53 ng√µ 19, T·ªë H·ªØu, Trung vƒÉn, Nam T·ª´ Li√™m, H√† N·ªôi",
                    phone = "0347324430",
                    email = "info@meomeoshop.com"
                }
            };

            // G·ªçi JavaScript ƒë·ªÉ in h√≥a ƒë∆°n chi ti·∫øt
            await JSRuntime.InvokeVoidAsync("printDetailedReceipt", receiptData);
            MessageService.Success($"ƒê√£ g·ª≠i l·ªánh in h√≥a ƒë∆°n chi ti·∫øt cho ƒë∆°n h√†ng {orderData.Code}");
        }
        catch (Exception ex)
        {
            MessageService.Error("Kh√¥ng th·ªÉ in h√≥a ƒë∆°n chi ti·∫øt: " + ex.Message);
        }
    }

    

    private async Task HandlePrintOrder()
    {
        if (CurrentOrderId == null)
        {
            MessageService.Warning("Vui l√≤ng t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng tr∆∞·ªõc khi in h√≥a ƒë∆°n");
            return;
        }

        if (!Products.Any())
        {
            MessageService.Warning("Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ in");
            return;
        }

        try
        {
            // T·∫°o d·ªØ li·ªáu h√≥a ƒë∆°n ƒë·ªÉ in v·ªõi th√¥ng tin ƒë∆°n h√†ng th·ª±c t·∫ø
            var receiptData = new
            {
                OrderCode = CurrentOrderCode,
                OrderId = CurrentOrderId,
                CustomerName = SelectedCustomer?.Name ?? "Kh√°ch l·∫ª",
                CustomerPhone = SelectedCustomer?.Phone ?? "",
                Items = Products.Select(p => new
                {
                    Name = p.ProductName,
                    SKU = p.Sku,
                    Quantity = p.Quantity,
                    Price = p.Price,
                    Total = p.GrandTotal
                }),
                SubTotal = CalculateSubTotal(),
                ShippingFee = ShippingFee,
                DiscountAmount = DiscountCodeAmount,
                Total = CalculateTotal(),
                PaymentMethod = PaymentType == 0 ? "Ti·ªÅn m·∫∑t" : "Chuy·ªÉn kho·∫£n",
                OrderType = OrderType == 0 ? "Giao tr·ª±c ti·∫øp" : "Giao h√†ng"
            };

            // G·ªçi JavaScript ƒë·ªÉ in h√≥a ƒë∆°n
            await JSRuntime.InvokeVoidAsync("printReceipt", receiptData);
            MessageService.Success($"ƒê√£ g·ª≠i l·ªánh in h√≥a ƒë∆°n cho ƒë∆°n h√†ng {CurrentOrderCode}");
        }
        catch (Exception ex)
        {
            MessageService.Error("Kh√¥ng th·ªÉ in h√≥a ƒë∆°n: " + ex.Message);
        }
    }

    private void HandleGoBack()
    {
        Navigation.NavigateTo("/orders");
    }

    private void HandleTypeChange(SelectOption selectedOption)
    {
        OrderType = selectedOption.Value;
        StateHasChanged();
    }

    private async Task FetchImageAsync()
    {
        if (string.IsNullOrEmpty(AccountNumber) || string.IsNullOrEmpty(BankBin))
            return;
            
        var url = $"https://img.vietqr.io/image/{BankBin}-{AccountNumber}-qr_only.png?amount={(int)CalculateTotal()}&addInfo={AddInfo}";
        try
        {
            var imageBytes = await ApiCaller.GetByteArrayAsync(url);
            QrBase64Image = $"data:image/png;base64,{Convert.ToBase64String(imageBytes)}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching QR code: {ex.Message}");
        }
    }

    private void OnCustomerSearch(string searchText)
    {
        CustomersLoading = true;
        CustomersLoading = false;
        StateHasChanged();
    }

    private void OnCustomerChanged(Customer customer)
    {
        SelectedCustomer = customer;
        if (customer.Id == Guid.Empty)
        {
            UseDefaultAddress = false;
            AvailableVouchers.Clear();
            SelectedVoucherId = null;
            SelectedVoucher = null;
            DiscountCodeAmount = 0;
        }
        else
        {
            // Load available vouchers when customer is selected
            _ = LoadAvailableVouchers();
        }

        StateHasChanged();
    }

    private void HandleAddNewCustomer()
    {
        AddCustomerModalVisible = true;
        newCustomerModel = new CreateQuickCustomerDTO();
    }

    private void HandleCloseAddCustomerModal()
    {
        AddCustomerModalVisible = false;
    }

    private async Task CreateQuickCustomerAsync()
    {
        if (string.IsNullOrWhiteSpace(newCustomerModel.Name) || string.IsNullOrWhiteSpace(newCustomerModel.PhoneNumber))
        {
            MessageService.Warning("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† s·ªë ƒëi·ªán tho·∫°i");
            return;
        }

        try
        {
            creatingCustomer = true;
            var resp = await CustomerClientService.CreateQuickCustomerAsync(newCustomerModel);
            if (resp != null && resp.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                MessageService.Success(resp.Message ?? "T·∫°o kh√°ch h√†ng nhanh th√†nh c√¥ng");

                // T·∫°o customer object t·ª´ response v√† select n√≥
                var newCustomer = new Customer
                {
                    Id = resp.CustomerId ?? Guid.Empty,
                    Name = resp.CustomerName ?? newCustomerModel.Name,
                    Phone = resp.PhoneNumber ?? newCustomerModel.PhoneNumber
                };

                // Th√™m v√†o danh s√°ch customers v√† select
                Customers.Insert(0, newCustomer);
                SelectedCustomer = newCustomer;
                OrderModel.CustomerId = newCustomer.Id;

                AddCustomerModalVisible = false;
            }
            else
            {
                MessageService.Error(resp?.Message ?? "T·∫°o kh√°ch h√†ng th·∫•t b·∫°i");
            }
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ t·∫°o kh√°ch h√†ng");
        }
        finally
        {
            creatingCustomer = false;
            StateHasChanged();
        }
    }

    private void OnProvinceSearch(string searchText)
    {
    }

    private void HandleProvinceChange(Province province)
    {
        SelectedProvinceId = province?.Id ?? 0;
        Districts.Clear();
        Communes.Clear();
        OrderModel.Delivery.DistrictId = null;
        OrderModel.Delivery.CommuneId = null;
        StateHasChanged();
        _ = LoadDistrictsAsync(SelectedProvinceId);
    }

    private void OnDistrictSearch(string searchText)
    {
    }

    private void HandleDistrictChange(District district)
    {
        SelectedDistrictId = district?.Id ?? 0;
        Communes.Clear();
        OrderModel.Delivery.CommuneId = null;
        StateHasChanged();
        _ = LoadCommunesAsync(SelectedDistrictId);
    }

    private void OnCommuneSearch(string searchText)
    {
    }

    private void HandleCommuneChange(Commune commune)
    {
        OrderModel.Delivery.CommuneId = commune?.Id;
        StateHasChanged();
    }

    private void OnSearchClick()
    {
        SearchDropdownVisible = true;
    }


    private async Task OnProductSearch(string searchText)
    {
        try
        {
            SearchingProduct = true;
            ProductSearchKeyword = searchText?.Trim() ?? string.Empty;

            if (string.IsNullOrEmpty(ProductSearchKeyword))
            {
                SearchResults.Clear();
                SearchDropdownVisible = false;
                return;
            }

            // C·∫≠p nh·∫≠t request v·ªõi keyword m·ªõi
            requestSearchProduct.SearchKeyword = ProductSearchKeyword;
            requestSearchProduct.PageIndex = 1; // Reset v·ªÅ trang ƒë·∫ßu khi search m·ªõi

            var result = await ProductClientService.SearchProductsAsync(requestSearchProduct);
            var items = result.Items ?? new List<ProductSearchResponseDTO>();

            SearchResults = items.ToList();

            SearchDropdownVisible = SearchResults.Any();
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ t√¨m s·∫£n ph·∫©m");
            SearchResults.Clear();
            SearchDropdownVisible = false;
        }
        finally
        {
            SearchingProduct = false;
            StateHasChanged();
        }
    }

    private void OnSearchClear()
    {
        ProductSearchKeyword = string.Empty;
        SearchResults.Clear();
        SearchDropdownVisible = false;
        StateHasChanged();
    }

    private Task AddProductToOrder(ProductSearchResponseDTO product)
    {
        if (product.StockQuantity <= 0)
        {
            MessageService.Warning("S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng");
            return Task.CompletedTask;
        }

        var existingProduct = Products.FirstOrDefault(p => p.ProductDetailId == product.ProductDetailId);
        if (existingProduct != null)
        {
            if (existingProduct.Quantity >= product.StockQuantity)
            {
                MessageService.Warning($"S·ªë l∆∞·ª£ng t·ªìn kho ch·ªâ c√≤n {product.StockQuantity}");
                return Task.CompletedTask;
            }

            existingProduct.Quantity++;
            existingProduct.GrandTotal = existingProduct.Price * existingProduct.Quantity;
        }
        else
        {
            // Calculate discount amount and percentage
            var finalPrice = product.SalePrice ?? product.Price;
            var discountAmount = product.Price - finalPrice;

            Products.Add(new OrderDetailDTO
            {
                Id = Guid.NewGuid(), // New OrderDetail Id
                OrderId = Guid.Empty, // Will be set when creating order
                ProductDetailId = product.ProductDetailId,
                PromotionDetailId = Guid.Empty, // Will be set by backend
                Sku = product.SKU,
                Price = (float)finalPrice,
                OriginalPrice = (float)product.Price,
                Quantity = 1,
                GrandTotal = (float)finalPrice,
                ProductName = product.ProductName,
                Discount = (float)discountAmount,
                Image = string.IsNullOrWhiteSpace(product.Thumbnail) ? string.Empty : product.Thumbnail,
                SizeName = product.SizeValue,
                ColourName = product.ColourName
            });
        }

        ReloadVouchersIfNeeded();
        SearchDropdownVisible = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async ValueTask ShowAllSearchResults()
    {
        try
        {
            SearchingProduct = true;
            requestSearchProduct.PageSize = 50;
            var result = await ProductClientService.SearchProductsAsync(requestSearchProduct);
            var items = result.Items ?? new List<ProductSearchResponseDTO>();
            SearchResults = items.ToList();
            SearchDropdownVisible = SearchResults.Any();
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ t·∫£i th√™m s·∫£n ph·∫©m");
        }
        finally
        {
            SearchingProduct = false;
            StateHasChanged();
        }
    }

    private async Task StartBarcodeScan()
    {
        try
        {
            IsBarcodeScanning = true;
            MessageService.Info("ƒêang kh·ªüi ƒë·ªông camera qu√©t barcode...");

            // G·ªçi JavaScript ƒë·ªÉ kh·ªüi ƒë·ªông camera
            var barcode = await JSRuntime.InvokeAsync<string>("startBarcodeScan");
            if (!string.IsNullOrEmpty(barcode))
            {
                // T√¨m s·∫£n ph·∫©m theo barcode b·∫±ng SearchProductsAsync
                var barcodeRequest = new ProductSearchRequestDTO
                {
                    PageIndex = 1,
                    PageSize = 1,
                    SearchKeyword = barcode,
                    InStockOnly = true
                };

                var result = await ProductClientService.SearchProductsAsync(barcodeRequest);
                var product = result.Items?.FirstOrDefault();

                if (product != null)
                {
                    await AddProductToOrder(product);
                }
                else
                {
                    MessageService.Warning($"Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi barcode: {barcode}");
                }
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera: " + ex.Message);
        }
        finally
        {
            IsBarcodeScanning = false;
            StateHasChanged();
        }
    }

    private async Task StartQRCodeScan()
    {
        try
        {
            IsQRCodeScanning = true;
            MessageService.Info("ƒêang kh·ªüi ƒë·ªông camera qu√©t QR code...");

            // G·ªçi JavaScript ƒë·ªÉ kh·ªüi ƒë·ªông camera qu√©t QR
            var qrData = await JSRuntime.InvokeAsync<string>("startQRCodeScan");
            if (!string.IsNullOrEmpty(qrData))
            {
                await ProcessQRCodeData(qrData);
            }
        }
        catch (Exception ex)
        {
            MessageService.Error("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera qu√©t QR: " + ex.Message);
        }
        finally
        {
            IsQRCodeScanning = false;
            StateHasChanged();
        }
    }

    private async Task ProcessQRCodeData(string qrData)
    {
        try
        {
            // Ki·ªÉm tra format QR code: PRODUCT:SKU:PRICE:SIZE:COLOR
            if (qrData.StartsWith("PRODUCT:"))
            {
                var parts = qrData.Split(':');
                if (parts.Length >= 2)
                {
                    var sku = parts[1];

                    // T√¨m s·∫£n ph·∫©m theo SKU
                    var product = await ProductClientService.GetProductBySkuAsync(sku);

                    if (product != null)
                    {
                        await AddProductToOrder(product);
                        MessageService.Success($"ƒê√£ th√™m s·∫£n ph·∫©m {product.ProductName} v√†o ƒë∆°n h√†ng");
                    }
                    else
                    {
                        MessageService.Warning($"Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi SKU: {sku}");
                    }
                }
                else
                {
                    MessageService.Warning("QR code kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
                }
            }
            else
            {
                // N·∫øu kh√¥ng ph·∫£i QR code s·∫£n ph·∫©m, th·ª≠ t√¨m ki·∫øm nh∆∞ barcode th√¥ng th∆∞·ªùng
                var barcodeRequest = new ProductSearchRequestDTO
                {
                    PageIndex = 1,
                    PageSize = 1,
                    SearchKeyword = qrData,
                    InStockOnly = true
                };

                var result = await ProductClientService.SearchProductsAsync(barcodeRequest);
                var product = result.Items?.FirstOrDefault();

                if (product != null)
                {
                    await AddProductToOrder(product);
                    MessageService.Success($"ƒê√£ th√™m s·∫£n ph·∫©m {product.ProductName} v√†o ƒë∆°n h√†ng");
                }
                else
                {
                    MessageService.Warning($"Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi d·ªØ li·ªáu: {qrData}");
                }
            }
        }
        catch (Exception ex)
        {
            MessageService.Error($"C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω QR code: {ex.Message}");
        }
    }

    private async Task LoadAvailableVouchers()
    {
        if (SelectedCustomer?.Id == Guid.Empty || SelectedCustomer?.Id == null)
            return;

        try
        {
            LoadingVouchers = true;
            var request = new GetAvailableVouchersRequestDTO
            {
                CustomerId = SelectedCustomer.Id,
                OrderAmount = CalculateSubTotal()
            };

            AvailableVouchers = await VoucherClientService.GetAvailableVouchersAsync(request);
        }
        catch (Exception ex)
        {
            MessageService.Error($"L·ªói khi t·∫£i danh s√°ch voucher: {ex.Message}");
            AvailableVouchers = new List<AvailableVoucherDTO>();
        }
        finally
        {
            LoadingVouchers = false;
            StateHasChanged();
        }
    }

    private void ShowVoucherModal()
    {
        if (SelectedCustomer?.Id == Guid.Empty || SelectedCustomer?.Id == null)
        {
            MessageService.Warning("Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc");
            return;
        }
        
        VoucherModalVisible = true;
        _ = LoadAvailableVouchers();
    }

    private void CloseVoucherModal()
    {
        VoucherModalVisible = false;
    }

    private void SelectVoucher(AvailableVoucherDTO voucher)
    {
        if (!voucher.CanUse)
        {
            MessageService.Warning(voucher.Reason ?? "Voucher kh√¥ng th·ªÉ s·ª≠ d·ª•ng");
            return;
        }

        SelectedVoucherId = voucher.Id;
        SelectedVoucherCode = voucher.Code;
        DiscountCodeAmount = (decimal)voucher.CalculatedDiscountAmount;
        SelectedVoucher = new OrderVoucher
        {
            Id = voucher.Id,
            Name = voucher.Name,
            Code = voucher.Code,
            DiscountAmount = (decimal)voucher.CalculatedDiscountAmount,
            DiscountPercent = voucher.Type == MeoMeo.Domain.Commons.Enums.EVoucherType.byPercentage ? (decimal)voucher.Discount : 0,
            MinOrderAmount = voucher.MinOrder,
            ExpiryDate = voucher.EndDate
        };
        DiscountCodeError = null;
        
        VoucherModalVisible = false;
        MessageService.Success($"√Åp d·ª•ng voucher th√†nh c√¥ng: -{DiscountCodeAmount.ToString("N0")} ƒë");
        StateHasChanged();
    }

    private void RemoveDiscountCode()
    {
        SelectedVoucherId = null;
        DiscountCodeAmount = 0;
        DiscountCodeError = null;
        StateHasChanged();
    }

    private void RemoveVoucher()
    {
        SelectedVoucherId = null;
        SelectedVoucherCode = string.Empty;
        SelectedVoucher = null;
        DiscountCodeAmount = 0;
        DiscountCodeError = null;
        StateHasChanged();
    }

    private void HandleRemoveSelectedProducts()
    {
        if (SelectedProducts.Any())
        {
            var count = SelectedProducts.Count;
            foreach (var product in SelectedProducts)
            {
                Products.Remove(product);
            }

            SelectedProducts.Clear();
            StateHasChanged();
            MessageService.Success($"ƒê√£ x√≥a {count} s·∫£n ph·∫©m");
        }
        else
        {
            MessageService.Warning("Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn");
        }
    }

    private Task UpdateProductQuantity(OrderDetailDTO product, int quantity)
    {
        if (quantity <= 0)
        {
            MessageService.Warning("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0");
            return Task.CompletedTask;
        }

        product.Quantity = quantity;
        product.GrandTotal = product.Price * product.Quantity;

        ReloadVouchersIfNeeded();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task RemoveProduct(OrderDetailDTO product)
    {
        Products.Remove(product);
        SelectedProducts.Remove(product);
        
        ReloadVouchersIfNeeded();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private decimal CalculateSubTotal()
    {
        return (decimal)Products.Sum(p => p.GrandTotal);
    }

    private void ReloadVouchersIfNeeded()
    {
        // Reload vouchers if customer is selected and subtotal changed
        if (SelectedCustomer?.Id != Guid.Empty && AvailableVouchers.Any())
        {
            _ = LoadAvailableVouchers();
        }
    }

    private decimal CalculateTotal()
    {
        var subTotal = CalculateSubTotal();
        var total = subTotal + ShippingFee - DiscountCodeAmount;
        return Math.Max(0, total);
    }

    private async Task LoadInitialData()
    {
        try
        {
            CustomersLoading = true;
            ProvincesLoading = true;

            var custReq = new MeoMeo.Contract.DTOs.GetListCustomerRequestDTO
            {
                PageIndex = 1,
                PageSize = 20
            };
            var custResp = await CustomerClientService.GetAllCustomersAsync(custReq);
            Customers = (custResp.Items ?? new List<MeoMeo.Contract.DTOs.CustomerDTO>())
            .Select(c => new Customer
            {
                Id = c.Id,
                Name = c.Name,
                Phone = c.PhoneNumber,
            })
            .ToList();

            // Load provinces via GHN
            var ghnProvinces = await GhnService.GetProvincesAsync();
            Provinces = (ghnProvinces ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
            .Select(p => new Province { Id = p.Id, Name = p.Name })
            .ToList();
        }
        catch
        {
            MessageService.Warning("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu");
        }
        finally
        {
            CustomersLoading = false;
            ProvincesLoading = false;
            StateHasChanged();
        }
    }

    private void OnFinish()
    {
    }

    private void OnFinishFailed()
    {
    }

    private async Task LoadDistrictsAsync(int provinceId)
    {
        try
        {
            DistrictsLoading = true;
            var ghnDistricts = await GhnService.GetDistrictsAsync(provinceId);
            Districts = (ghnDistricts ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
            .Select(d => new District { Id = d.Id, Name = d.Name })
            .ToList();
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch qu·∫≠n/huy·ªán");
        }
        finally
        {
            DistrictsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCommunesAsync(int districtId)
    {
        try
        {
            CommunesLoading = true;
            var ghnWards = await GhnService.GetWardsAsync(districtId);
            Communes = (ghnWards ?? new List<MeoMeo.Shared.DTOs.GhnLocationItem>())
            .Select(w => new Commune { Id = w.Id, Name = w.Name })
            .ToList();
        }
        catch
        {
            MessageService.Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph∆∞·ªùng/x√£");
        }
        finally
        {
            CommunesLoading = false;
            StateHasChanged();
        }
    }

    // Method ƒë·ªÉ load ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω
    private async Task LoadPendingOrders()
    {
        try
        {
            LoadingPendingOrders = true;
            
            var request = new GetPendingOrdersRequestDTO
            {
                PageIndex = 1,
                PageSize = 10,
                FromDate = DateTime.Today.AddDays(-7), // L·∫•y ƒë∆°n h√†ng trong 7 ng√†y g·∫ßn ƒë√¢y
                ToDate = DateTime.Now
            };

            var result = await OrderClientService.GetPendingOrdersAsync(request);
            if (result != null)
            {
                PendingOrders = result.Items?.Select(o => new PendingOrderItem
                {
                    Id = o.Id,
                    Code = o.Code,
                    CustomerName = o.CustomerName,
                    TotalAmount = o.TotalAmount,
                    CreationTime = o.CreationTime,
                    Status = (int)o.Status
                }).ToList() ?? new List<PendingOrderItem>();
            }
            else
            {
                PendingOrders = new List<PendingOrderItem>();
            }
        }
        catch (Exception ex)
        {
            MessageService.Error($"Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω: {ex.Message}");
            PendingOrders = new List<PendingOrderItem>();
        }
        finally
        {
            LoadingPendingOrders = false;
            StateHasChanged();
        }
    }

    // Method ƒë·ªÉ ti·∫øp t·ª•c x·ª≠ l√Ω ƒë∆°n h√†ng ƒë√£ l∆∞u t·∫°m
    private async Task ResumeOrder(PendingOrderItem order)
    {
        try
        {
            
            var orderDetail = await OrderClientService.GetOrderByIdAsync(order.Id);
            if (orderDetail == null)
            {
                MessageService.Error("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng");
                return;
            }
            Products.Clear();
            SelectedProducts.Clear();
            SearchResults.Clear();
            SearchDropdownVisible = false;
            SelectedCustomer = null;
            SelectedProvinceId = 0;
            SelectedDistrictId = 0;
            ShippingFee = 0;
            DiscountCode = string.Empty;
            DiscountCodeError = null;
            DiscountCodeAmount = 0;
            SelectedVoucher = null;
            PaymentType = 0;
            ProductSearchKeyword = string.Empty;
            CurrentOrderId = orderDetail.Id;
            CurrentOrderCode = orderDetail.Code;
            OrderType = (int)orderDetail.Type;
            OrderModel.Type = OrderType;
            PaymentType = (int)orderDetail.PaymentMethod;
            ShippingFee = orderDetail.ShippingFee ?? 0;
            OrderModel.Delivery.ConsigneeNote = orderDetail.Note ?? string.Empty;
            
            // Load QR code if payment method is transfer
            if (PaymentType == 1)
            {
                await FetchImageAsync();
            }
            if (orderDetail.CustomerId != Guid.Empty)
            {
                var customer = Customers.FirstOrDefault(c => c.Id == orderDetail.CustomerId);
                if (customer == null)
                {
                    // T·∫°o customer object t·ª´ order detail
                    customer = new Customer
                    {
                        Id = orderDetail.CustomerId,
                        Name = orderDetail.CustomerName,
                        Phone = orderDetail.CustomerPhoneNumber
                    };
                    Customers.Insert(0, customer);
                }
                SelectedCustomer = customer;
                OrderModel.CustomerId = customer.Id;
            }

           
            // Load danh s√°ch s·∫£n ph·∫©m tr·ª±c ti·∫øp t·ª´ OrderDetailDTO
            Products.Clear();
            if (orderDetail.OrderDetails?.Any() == true)
            {
                foreach (var detail in orderDetail.OrderDetails)
                {
                    Products.Add(detail);
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            MessageService.Error($"Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng: {ex.Message}");
        }
    }

    // Method ƒë·ªÉ h·ªßy ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω
    private void CancelPendingOrder(PendingOrderItem order)
    {
        OrderToCancel = new OrderDTO
        {
            Id = order.Id,
            Code = order.Code,
            CustomerName = order.CustomerName,
            TotalPrice = order.TotalAmount
        };
        CancelReason = "Kh√°ch h√†ng y√™u c·∫ßu h·ªßy";
        CancelOrderModalVisible = true;
    }

    private void CloseCancelOrderModal()
    {
        CancelOrderModalVisible = false;
        OrderToCancel = null;
        CancelReason = "Kh√°ch h√†ng y√™u c·∫ßu h·ªßy";
    }

    private void ClosePaymentInfoModal()
    {
        PaymentInfoModalVisible = false;
    }

    private string GetProvinceName()
    {
        return Provinces.FirstOrDefault(p => p.Id == OrderModel.Delivery.ProvinceId)?.Name ?? "";
    }

    private string GetDistrictName()
    {
        return Districts.FirstOrDefault(d => d.Id == OrderModel.Delivery.DistrictId)?.Name ?? "";
    }

    private string GetCommuneName()
    {
        return Communes.FirstOrDefault(c => c.Id == OrderModel.Delivery.CommuneId)?.Name ?? "";
    }

    private void SelectCashPayment()
    {
        PaymentType = 0;
        PaymentInfoModalVisible = false;
        StateHasChanged();
    }

    private async Task SelectTransferPayment()
    {
        PaymentType = 1;
        await FetchImageAsync();
        PaymentInfoModalVisible = true;
        StateHasChanged();
    }

    private async Task ConfirmCancelOrder()
    {
        if (OrderToCancel == null || string.IsNullOrWhiteSpace(CancelReason))
        {
            MessageService.Warning("Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng");
            return;
        }

        try
        {
            var result = await OrderClientService.CancelOrderWithReasonAsync(OrderToCancel.Id, CancelReason);
            
            if (result != null && result.ResponseStatus == MeoMeo.Contract.Commons.BaseStatus.Success)
            {
                MessageService.Success($"ƒê√£ h·ªßy ƒë∆°n h√†ng {OrderToCancel.Code}");
                
                await LoadPendingOrders();
                
                CloseCancelOrderModal();
            }
            else
            {
                MessageService.Error(result?.Message ?? "Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng");
            }
        }
        catch (Exception ex)
        {
            MessageService.Error($"L·ªói khi h·ªßy ƒë∆°n h√†ng: {ex.Message}");
        }
    }

}

